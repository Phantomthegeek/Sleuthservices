<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard - Sleuthservice</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <script src="icons.js" defer></script>
    <script src="terms-acceptance.js" defer></script>
    <script src="siteConfig.js" defer></script>
    <style>
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        html, body {
            overflow-x: hidden !important;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .client-container {
            min-height: 100vh;
            height: auto;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 30%, #334155 60%, #1e293b 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            overflow-y: visible !important;
            overflow-x: hidden;
        }
        
        .client-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(30,64,175,0.03)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .client-header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 3px solid #06b6d4;
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 8px 32px rgba(30, 64, 175, 0.25), 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        
        .client-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
        
        .client-header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .client-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        /* Full Screen Loading Overlay */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-screen h2 {
            color: white;
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }
        
        .loading-screen p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin: 0;
        }
        
        .client-container.loading {
            overflow: hidden;
        }
        
        /* Message Modal Styles */
        .message-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .message-modal-overlay.active {
            display: flex;
        }

        .message-modal-panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(6, 182, 212, 0.3);
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            animation: slideUp 0.3s ease;
            transform: scale(1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        /* Enhanced Card Styles */
        .card, [class*="case-card"], .status-tracker {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover, [class*="case-card"]:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 16px 48px rgba(30, 64, 175, 0.2), 0 4px 16px rgba(0, 0, 0, 0.1) !important;
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        /* Enhanced Button Styles */
        button, .btn, [type="button"], [type="submit"] {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover:not(:disabled), .btn:hover:not(:disabled), [type="button"]:hover:not(:disabled), [type="submit"]:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.35) !important;
        }
        
        button:active:not(:disabled), .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .message-modal-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
        }

        .message-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-message-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .close-message-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .message-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message-modal-footer {
            padding: 1.5rem;
            border-top: 2px solid var(--border);
            background: #f8fafc;
        }
        
        .welcome-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(30, 64, 175, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .case-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 1.25rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 1.5rem;
            border: 1px solid rgba(6, 182, 212, 0.2);
            position: relative;
            overflow: visible;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s ease-out backwards;
            color: var(--text);
        }
        
        .case-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
            transition: width 0.3s ease;
        }
        
        .case-card:hover::before {
            width: 6px;
        }
        
        .case-card:hover {
            border-color: rgba(6, 182, 212, 0.4);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.2), 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .case-card:nth-child(1) { animation-delay: 0.1s; }
        .case-card:nth-child(2) { animation-delay: 0.2s; }
        .case-card:nth-child(3) { animation-delay: 0.3s; }
        .case-card:nth-child(4) { animation-delay: 0.4s; }
        .case-card:nth-child(n+5) { animation-delay: 0.5s; }
        
        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .case-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .status-badge:hover::before {
            left: 100%;
        }
        
        .status-new { 
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }
        .status-in-progress { 
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .status-completed { 
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        .status-on-hold { 
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #374151;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }
        
        .case-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(249, 250, 251, 0.8) 0%, rgba(241, 245, 249, 0.9) 100%);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.5);
        }
        
        .case-info-item {
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        .case-info-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.1);
        }
        
        .case-info-item strong {
            font-size: 0.7rem;
            color: var(--text);
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .case-info-item span {
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }
        
        .case-files {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .case-files h4 {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(249, 250, 251, 0.95) 100%);
            border-radius: 0.75rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }
        
        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(30, 64, 175, 0.12);
            border-color: rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(249, 250, 251, 1) 100%);
        }
        
        .file-item a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .file-item a:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .case-updates {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .case-updates h4 {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .update-item {
            padding: 1.25rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.98) 100%);
            border-radius: 0.75rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .update-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            transition: width 0.3s ease;
        }
        
        .update-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(30, 64, 175, 0.12);
        }
        
        .update-item:hover::before {
            width: 6px;
        }
        
        .update-message {
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .update-meta {
            font-size: 0.75rem;
            color: var(--text);
            opacity: 0.9;
            display: flex;
            gap: 1rem;
        }
        
        .no-cases {
            text-align: center;
            padding: 3rem;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(6, 182, 212, 0.2);
            color: var(--text);
            border-radius: 1rem;
            box-shadow: var(--shadow);
        }
        
        .error-container {
            text-align: center;
            padding: 3rem;
        }
        
        .error-container h2 {
            color: var(--error);
            margin-bottom: 1rem;
        }
        
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            font-weight: 500;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Full Screen Loading Overlay -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <h2>Loading Your Dashboard</h2>
        <p>Please wait while we retrieve your cases...</p>
    </div>
    
    <div class="client-container loading" id="mainContainer">
        <div class="client-header">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h1>Client Dashboard</h1>
            </div>
        </div>
        
        <div class="client-content">
            <div id="errorContainer" class="error-container hidden">
                <h2>Authentication Error</h2>
                <p id="errorMessage" role="alert" aria-live="polite" aria-atomic="true"></p>
                <a href="client-login.html" class="btn btn-primary" style="margin-top: 1rem;">Return to Login</a>
            </div>
            
            <div id="dashboardContainer" class="hidden">
            <div class="welcome-section">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
                    <div>
                        <h2 style="margin: 0 0 0.75rem 0; font-size: 2rem; color: var(--text); font-weight: 800; letter-spacing: -0.5px; line-height: 1.2;">
                            Welcome, <span id="clientName" style="background: linear-gradient(135deg, #1e40af, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Client</span> <span data-icon="welcome" style="display: inline-block; vertical-align: middle; margin-left: 0.5rem;"></span>
                        </h2>
                        <p style="margin: 0; color: var(--text); opacity: 0.9; font-size: 1.05rem; font-weight: 500; line-height: 1.6;">View and manage all your cases in one place. Track progress and stay updated with real-time notifications.</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <button id="searchCasesBtn" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.625rem; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600; font-size: 0.95rem;" type="button">
                            <span data-icon="search" style="display: inline-block; width: 18px; height: 18px;"></span>
                            <span>Search Cases</span>
                        </button>
                        <button id="openInquiryFormBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.625rem; padding: 0.875rem 1.75rem; border-radius: 0.75rem; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 16px rgba(30, 64, 175, 0.3);">
                            <span data-icon="add" style="display: inline-block; width: 18px; height: 18px;"></span>
                            <span>Submit New Inquiry</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search Bar (Initially Hidden) -->
            <div id="searchSection" class="hidden" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); padding: 2rem; border-radius: 1.25rem; box-shadow: 0 8px 32px rgba(30, 64, 175, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.8); animation: fadeInUp 0.4s ease-out;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="caseSearchInput" placeholder="Search by Case ID, service type, or status..." 
                           style="flex: 1; min-width: 250px; padding: 1rem; border: 2px solid rgba(226, 232, 240, 0.8); border-radius: 0.75rem; font-size: 0.95rem; background: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;"
                           onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                           onblur="this.style.borderColor='rgba(226, 232, 240, 0.8)'; this.style.boxShadow='none'">
                    <select id="statusFilterSelect" style="padding: 1rem; border: 2px solid rgba(226, 232, 240, 0.8); border-radius: 0.75rem; font-size: 0.95rem; background: rgba(255, 255, 255, 0.9); cursor: pointer; transition: all 0.3s ease;"
                            onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                            onblur="this.style.borderColor='rgba(226, 232, 240, 0.8)'; this.style.boxShadow='none'">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                    <button id="clearSearchBtn" class="btn btn-secondary" style="padding: 1rem 1.75rem; border-radius: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(107, 114, 128, 0.2);">Clear</button>
                </div>
            </div>
                
                <div id="casesContainer"></div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="message-modal-overlay">
        <div class="message-modal-panel">
            <div class="message-modal-header">
                <h3>
                    <span>ðŸ’¬</span>
                    <span id="modalCaseId">Messages</span>
                </h3>
                <button class="close-message-modal" id="closeMessageBtn">âœ•</button>
            </div>
            <div class="message-modal-body" id="messageModalBody">
                <!-- Messages will be loaded here dynamically -->
            </div>
            <div class="message-modal-footer" id="messageModalFooter">
                <!-- Message input form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- New Inquiry Form Modal -->
    <div id="inquiryModal" class="message-modal-overlay">
        <div class="message-modal-panel" style="max-width: 700px; max-height: 90vh;">
            <div class="message-modal-header">
                <h3>
                    <span data-icon="add" style="display: inline-block; width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"></span>
                    <span>Submit New Inquiry</span>
                </h3>
                <button class="close-message-modal" id="closeInquiryBtn">âœ•</button>
            </div>
            <div class="message-modal-body" style="overflow-y: auto;">
                <form id="clientInquiryForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Full Name *</label>
                        <input type="text" name="name" id="inquiryName" placeholder="Your full name" required 
                               style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-size: 0.95rem;">
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Email Address *</label>
                        <input type="email" name="email" id="inquiryEmail" placeholder="your.email@example.com" required
                               style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-size: 0.95rem; color: #000000 !important;">
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Phone Number</label>
                        <input type="tel" name="phone" id="inquiryPhone" placeholder="+1 (555) 123-4567" 
                               style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-size: 0.95rem;">
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Service Type *</label>
                        <select name="service" id="inquiryService" required 
                                style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-size: 0.95rem; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); color: #000000;">
                            <option value="">Select Service</option>
                            <option value="Digital Forensics">Digital Forensics</option>
                            <option value="Due Diligence">Due Diligence</option>
                            <option value="Background Screening">Background Screening</option>
                            <option value="Surveillance">Surveillance</option>
                            <option value="Asset Tracing">Asset Tracing</option>
                            <option value="Corporate Due Diligence">Corporate Due Diligence</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Case Description *</label>
                        <textarea name="message" id="inquiryMessage" rows="5" placeholder="Brief description of your case..." required 
                                  style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-size: 0.95rem; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text); font-size: 0.9rem;">Attach Files (Optional)</label>
                        <input type="file" id="inquiryFileInput" name="files" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt" 
                               style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; font-size: 0.95rem;">
                        <div id="inquiryFileList" style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">No files selected</div>
                        <small style="font-size: 0.75rem; color: var(--text-light);">Max 10MB per file. PDF, images, documents allowed.</small>
                    </div>
                    
                    <div id="inquiryFormStatus" class="form-status" style="display: none;"></div>
                </form>
            </div>
            <div class="message-modal-footer">
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" id="cancelInquiryBtn" class="btn btn-secondary" style="padding: 0.75rem 2rem;">Cancel</button>
                    <button type="submit" form="clientInquiryForm" id="submitInquiryBtn" class="btn btn-primary" style="padding: 0.75rem 2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span id="submitInquiryText">Submit Inquiry</span>
                        <span id="submitInquiryLoading" class="spinner" style="display: none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let allCases = [];
        
        // Utility Functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getStatusProgress(status) {
            const statusMap = { 'new': 25, 'in-progress': 60, 'on-hold': 40, 'completed': 100 };
            return statusMap[status] || 25;
        }
        
        function getStatusSteps(status) {
            const steps = [
                { id: 'submitted', label: 'Submitted', icon: 'document', completed: true },
                { id: 'review', label: 'Under Review', icon: 'document', completed: status !== 'new' },
                { id: 'investigation', label: 'Investigation', icon: 'search', completed: status === 'in-progress' || status === 'completed' },
                { id: 'report', label: 'Report Ready', icon: 'document', completed: status === 'completed' }
            ];
            
            let activeStepIndex = 0;
            if (status === 'new') activeStepIndex = 0;
            else if (status === 'in-progress') activeStepIndex = 2;
            else if (status === 'completed') activeStepIndex = 3;
            else if (status === 'on-hold') activeStepIndex = 1;
            
            return { steps, activeStepIndex };
        }
        
        function getFileIcon(filename) {
            if (filename.match(/\.(pdf)$/i)) return 'document';
            if (filename.match(/\.(jpg|jpeg|png|gif)$/i)) return 'document';
            if (filename.match(/\.(xlsx|xls|csv)$/i)) return 'document';
            if (filename.match(/\.(doc|docx)$/i)) return 'document';
            return 'document';
        }
        
        function formatFileSize(bytes) {
            const mb = bytes / 1024 / 1024;
            return mb > 1 ? `${mb.toFixed(2)} MB` : `${(bytes / 1024).toFixed(1)} KB`;
        }
        
        function getUpdateIcon(status) {
            const iconMap = {
                'new': 'document',
                'in-progress': 'refresh',
                'completed': 'success',
                'on-hold': 'warning',
                'default': 'document'
            };
            return iconMap[status] || iconMap['default'];
        }
        
        function getStatusColor(status) {
            const colors = {
                'new': '#f59e0b',
                'in-progress': '#3b82f6',
                'completed': '#10b981',
                'on-hold': '#6b7280'
            };
            return colors[status] || '#6b7280';
        }
        
        // Search and Filter Functions
        function filterCases() {
            const searchTerm = (document.getElementById('caseSearchInput')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('statusFilterSelect')?.value || '';
            const caseCards = document.querySelectorAll('.case-card');
            let visibleCount = 0;
            
            caseCards.forEach(card => {
                const caseId = card.getAttribute('data-case-id') || '';
                const caseStatus = card.getAttribute('data-case-status') || '';
                const caseService = card.getAttribute('data-case-service') || '';
                
                const matchesSearch = !searchTerm || 
                    caseId.toLowerCase().includes(searchTerm) || 
                    caseService.includes(searchTerm) ||
                    caseStatus.includes(searchTerm);
                
                const matchesStatus = !statusFilter || caseStatus === statusFilter;
                
                const shouldShow = matchesSearch && matchesStatus;
                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Show/hide "no results" message
            const container = document.getElementById('casesContainer');
            let noResultsMsg = container?.querySelector('.no-results-message');
            
            if (visibleCount === 0 && caseCards.length > 0) {
                if (!noResultsMsg && container) {
                    container.insertAdjacentHTML('afterbegin', `
                        <div class="no-results-message" style="text-align: center; padding: 3rem; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 0.75rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; color: var(--text);">
                            <div data-icon="search" style="display: inline-block; width: 48px; height: 48px; margin-bottom: 1rem;"></div>
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--text);">No cases found</h3>
                            <p style="margin: 0; color: var(--text-light);">Try adjusting your search or filter criteria.</p>
                        </div>
                    `);
                    // Initialize icons after inserting HTML
                    if (window.initAllIcons) {
                        setTimeout(() => window.initAllIcons(), 50);
                    }
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        function initializeSearchFilter() {
            const searchBtn = document.getElementById('searchCasesBtn');
            const searchSection = document.getElementById('searchSection');
            const searchInput = document.getElementById('caseSearchInput');
            const statusFilter = document.getElementById('statusFilterSelect');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            // Toggle search panel
            if (searchBtn && searchSection) {
                searchBtn.addEventListener('click', () => {
                    searchSection.classList.toggle('hidden');
                    if (!searchSection.classList.contains('hidden')) {
                        searchInput?.focus();
                    }
                });
            }
            
            // Real-time search
            searchInput?.addEventListener('input', filterCases);
            
            // Status filter
            statusFilter?.addEventListener('change', filterCases);
            
            // Clear filters
            clearSearchBtn?.addEventListener('click', () => {
                if (searchInput) searchInput.value = '';
                if (statusFilter) statusFilter.value = '';
                filterCases();
            });
        }
        
        // Detect backend URL dynamically
        const getBackendUrl = () => {
            const hostname = window.location.hostname;
            const port = window.location.port || '3001';
            const protocol = window.location.protocol;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '') {
                return `http://localhost:${port}`;
            }
            return `${protocol}//${hostname}${port ? ':' + port : ''}`;
        };
        
        // Main Dashboard Functions
        async function loadDashboard() {
            try {
                // Get token from URL first, then check localStorage (for page refresh)
                const urlParams = new URLSearchParams(window.location.search);
                let token = urlParams.get('token');
                
                // If no token in URL, try localStorage (for page refresh support)
                if (!token) {
                    token = localStorage.getItem('clientToken');
                    if (token) {
                        // Update URL to include token (for consistency)
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('token', token);
                        window.history.replaceState({}, '', newUrl);
                        console.log('âœ… Token retrieved from localStorage');
                    }
                } else {
                    // Store token in localStorage if coming from URL
                    localStorage.setItem('clientToken', token);
                }
                
                if (!token) {
                    showError('No access token found. Please login again.');
                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'client-login.html';
                    }, 3000);
                    return;
                }
                
                // Fetch cases
                const response = await fetch(`${getBackendUrl()}/api/client/cases?token=${token}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    showError(errorData.error || `Failed to load cases (${response.status})`);
                    return;
                }
                
                const data = await response.json();
                
                // API response received
                
                if (!data || !data.success) {
                    // API returned error (logged but not exposed to user)
                    showError(data?.error || 'Failed to load cases');
                    return;
                }
                
                // Hide loading screen and show dashboard
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContainer = document.getElementById('mainContainer');
                const dashboardContainer = document.getElementById('dashboardContainer');
                const errorContainer = document.getElementById('errorContainer');
                
                if (!dashboardContainer) {
                    // Dashboard container not found
                    showError('Dashboard container not found');
                    return;
                }
                
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        if (mainContainer) mainContainer.classList.remove('loading');
                    }, 300);
                }
                
                // Hide error container and show dashboard
                if (errorContainer) errorContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                
                if (data.cases.length === 0) {
                    document.getElementById('casesContainer').innerHTML = `
                        <div class="no-cases">
                            <h3>No Cases Found</h3>
                            <p>You don't have any active cases yet.</p>
                            <button id="openInquiryFormBtnEmpty" class="btn btn-primary" style="margin-top: 1rem;">Submit a New Case</button>
                        </div>
                    `;
                    return;
                }
                
                // Store token globally for reply forms
                window.clientToken = token;
                
                // Store all cases for filtering
                allCases = data.cases;
                
                // Render cases
                document.getElementById('casesContainer').innerHTML = data.cases.map(renderCase).join('');
                
                // Initialize icons for rendered cases
                setTimeout(() => {
                    if (window.initAllIcons) {
                        window.initAllIcons();
                    }
                }, 100);
                
                // Attach event listeners to download buttons
                document.querySelectorAll('.download-all-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const caseId = this.getAttribute('data-case-id');
                        const token = this.getAttribute('data-token');
                        downloadAllFiles(caseId, token);
                    });
                });
                
                // Check for new updates and show notifications
                checkForNewUpdates(data.cases);
                
                // Initialize search/filter functionality
                initializeSearchFilter();
                
                // Auto-scroll all message containers to bottom
                setTimeout(() => {
                    document.querySelectorAll('.messages-thread').forEach(container => {
                        container.scrollTop = container.scrollHeight;
                    });
                }, 300);
                
            } catch (error) {
                // Error loading dashboard (details not exposed)
                showError('Failed to load dashboard: ' + error.message);
            }
        }
        
        function checkForNewUpdates(cases) {
            const lastView = localStorage.getItem('lastDashboardView') || new Date().toISOString();
            const hasNewUpdates = cases.some(caseItem => {
                const lastUpdate = caseItem.updatedAt || caseItem.createdAt;
                return new Date(lastUpdate) > new Date(lastView);
            });
            
            if (hasNewUpdates) {
                showToast('You have new updates!', 'info');
            }
            
            localStorage.setItem('lastDashboardView', new Date().toISOString());
        }
        
        function renderCase(caseItem) {
            const files = caseItem.files || [];
            const updates = caseItem.updates || [];
            const token = new URLSearchParams(window.location.search).get('token');
            const progress = getStatusProgress(caseItem.status);
            const { steps, activeStepIndex } = getStatusSteps(caseItem.status);
            
            // Extract client name from first case for welcome message
            const clientNameEl = document.getElementById('clientName');
            if (caseItem.name && clientNameEl && (clientNameEl.textContent === 'Client' || !clientNameEl.textContent)) {
                clientNameEl.textContent = caseItem.name.split(' ')[0] || 'Client';
            }
            
            // Escape all user data to prevent XSS
            const safeId = escapeHtml(caseItem.id);
            const safeService = escapeHtml(caseItem.service || 'General Inquiry');
            const safeStatus = escapeHtml(caseItem.status);
            
            return `
                <div class="case-card" data-case-id="${safeId}" data-case-status="${safeStatus}" data-case-service="${escapeHtml((caseItem.service || '').toLowerCase())}">
                    <div class="case-header">
                        <div>
                            <div class="case-title">${safeId}</div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.25rem;">
                                Service: ${safeService}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">
                                Created: ${new Date(caseItem.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        </div>
                        <span class="status-badge status-${safeStatus}">${safeStatus}</span>
                    </div>
                    
                    <!-- Visual Status Tracker -->
                    <div style="margin: 2rem 0; padding: 2.5rem; background: linear-gradient(135deg, rgba(248, 250, 252, 0.98) 0%, rgba(255, 255, 255, 1) 100%); backdrop-filter: blur(20px); border-radius: 1.25rem; border: 1px solid rgba(226, 232, 240, 0.9); box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.8), 0 8px 24px rgba(30, 64, 175, 0.12); position: relative; overflow: hidden;">
                        <!-- Decorative gradient overlay -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%); background-size: 200% 100%; animation: shimmer 3s ease-in-out infinite;"></div>
                        
                        <h4 style="margin: 0 0 2rem 0; font-size: 0.9rem; color: #475569; text-transform: uppercase; letter-spacing: 0.15em; font-weight: 800; display: flex; align-items: center; gap: 0.75rem; position: relative; z-index: 1;">
                            <span data-icon="document" style="display: inline-block; width: 20px; height: 20px; filter: drop-shadow(0 2px 4px rgba(30, 64, 175, 0.2));"></span>
                            <span>Status Tracker</span>
                        </h4>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; padding: 1rem 0;">
                            ${steps.map((step, index) => {
                                const isCompleted = step.completed;
                                const isActive = index === activeStepIndex && !isCompleted;
                                const isUpcoming = index > activeStepIndex && !isCompleted;
                                const isConnected = index < activeStepIndex;
                                
                                // Determine background gradient
                                let bgGradient = '#e2e8f0';
                                if (isCompleted) {
                                    bgGradient = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                                } else if (isActive) {
                                    bgGradient = 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)';
                                }
                                
                                // Pulse animation for active step
                                const pulseStyle = isActive ? 'animation: statusPulse 2s ease-in-out infinite;' : '';
                                
                                return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; z-index: 3;">
                                        <!-- Step Circle -->
                                        <div style="width: 4rem; height: 4rem; border-radius: 50%; 
                                                    background: ${isCompleted || isActive ? bgGradient : '#e2e8f0'}; 
                                                    display: flex; align-items: center; justify-content: center; 
                                                    color: ${isCompleted || isActive ? 'white' : 'var(--text)'}; 
                                                    font-size: 1.5rem; 
                                                    margin-bottom: 1rem;
                                                    box-shadow: ${isCompleted ? '0 8px 16px rgba(16, 185, 129, 0.3), 0 0 0 4px rgba(16, 185, 129, 0.1)' : isActive ? '0 8px 16px rgba(59, 130, 246, 0.4), 0 0 0 4px rgba(59, 130, 246, 0.15)' : '0 2px 8px rgba(0, 0, 0, 0.08)'}; 
                                                    border: ${isCompleted || isActive ? '4px' : '3px'} solid white;
                                                    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                                                    transform: ${isActive ? 'scale(1.1)' : 'scale(1)'};
                                                    position: relative;
                                                    ${pulseStyle}">
                                            ${isCompleted ? '<span data-icon="success" style="display: inline-block; width: 28px; height: 28px; vertical-align: middle;"></span>' : `<span data-icon="${step.icon}" style="display: inline-block; width: 28px; height: 28px; vertical-align: middle; filter: ${isActive ? 'drop-shadow(0 2px 8px rgba(255,255,255,0.5))' : 'none'};"></span>`}
                                            ${isActive ? '<div style="position: absolute; inset: -8px; border-radius: 50%; border: 2px solid rgba(59, 130, 246, 0.3); animation: statusPulseRing 2s ease-in-out infinite;"></div>' : ''}
                                        </div>
                                        <!-- Step Label -->
                                        <div style="text-align: center; font-size: 0.8rem; color: ${isCompleted ? '#10b981' : isActive ? '#3b82f6' : 'var(--text)'}; opacity: ${isCompleted || isActive ? '1' : '0.9'}; font-weight: ${isCompleted || isActive ? '700' : '500'}; max-width: 90px; line-height: 1.3;">
                                            ${step.label}
                                        </div>
                                        ${isCompleted ? '<div style="position: absolute; top: 2.25rem; width: 12px; height: 12px; background: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>' : ''}
                                    </div>
                                    ${index < steps.length - 1 ? `
                                        <!-- Connecting Line -->
                                        <div style="position: absolute; left: ${(index + 1) * 25}%; top: 2rem; width: ${25 - 4}%; 
                                                    height: 3px; 
                                                    background: ${isConnected ? 'linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #60a5fa 100%)' : '#e2e8f0'}; 
                                                    background-size: ${isConnected ? '200% 100%' : '100% 100%'};
                                                    animation: ${isConnected ? 'gradientShift 2s ease infinite' : 'none'};
                                                    transform: translateX(-50%); 
                                                    z-index: 1;
                                                    border-radius: 2px;
                                                    box-shadow: ${isConnected ? '0 2px 4px rgba(59, 130, 246, 0.2)' : 'none'};
                                                    position: relative;
                                                    overflow: hidden;">
                                            ${isConnected ? '<div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent); animation: lineShimmer 1.5s ease-in-out infinite;"></div>' : ''}
                                        </div>
                                    ` : ''}
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <style>
                        @keyframes statusPulse {
                            0%, 100% { 
                                transform: scale(1.1);
                                box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4), 0 0 0 4px rgba(59, 130, 246, 0.15);
                            }
                            50% { 
                                transform: scale(1.15);
                                box-shadow: 0 12px 24px rgba(59, 130, 246, 0.5), 0 0 0 6px rgba(59, 130, 246, 0.2);
                            }
                        }
                        
                        @keyframes statusPulseRing {
                            0% {
                                opacity: 1;
                                transform: scale(1);
                            }
                            100% {
                                opacity: 0;
                                transform: scale(1.3);
                            }
                        }
                        
                        @keyframes lineShimmer {
                            0% { left: -100%; }
                            100% { left: 100%; }
                        }
                    </style>
                    
                    <!-- Progress Percentage -->
                    <div style="margin: 1.5rem 0 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.95) 100%); border-radius: 0.75rem; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 2px 8px rgba(30, 64, 175, 0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; font-size: 0.95rem;">
                            <span style="font-weight: 700; color: #475569; display: flex; align-items: center; gap: 0.5rem;">
                                <span>ðŸ“ˆ</span>
                                <span>Overall Progress</span>
                            </span>
                            <span style="font-weight: 800; font-size: 1.1rem; color: #1e40af; background: linear-gradient(135deg, #1e40af, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${progress}%</span>
                        </div>
                        <div style="width: 100%; height: 12px; background: #e2e8f0; border-radius: 9999px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06); position: relative;">
                            <div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, #3b82f6 0%, #1e40af 50%, #60a5fa 100%); background-size: 200% 100%; animation: gradientShift 3s ease infinite; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4); position: relative;">
                                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); animation: shimmer 2s ease-in-out infinite;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="case-info">
                        <div class="case-info-item">
                            <strong>Created</strong>
                            <span>${new Date(caseItem.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="case-info-item">
                            <strong>Last Updated</strong>
                            <span>${new Date(caseItem.updatedAt || caseItem.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="case-info-item">
                            <strong>Contact</strong>
                            <span>${escapeHtml(caseItem.name || 'N/A')}</span>
                        </div>
                        <div class="case-info-item">
                            <strong>Email</strong>
                            <span>${escapeHtml(caseItem.email || 'N/A')}</span>
                        </div>
                    </div>
                    
                    ${caseItem.message ? `
                        <div style="padding: 1rem; background: var(--background); border-radius: 0.5rem; margin-bottom: 1rem;">
                            <strong style="display: block; margin-bottom: 0.5rem;">Case Details:</strong>
                            <p style="margin: 0; color: var(--text); white-space: pre-wrap;">${escapeHtml(caseItem.message)}</p>
                        </div>
                    ` : ''}
                    
                    ${files.length > 0 ? `
                        <div class="case-files" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <div>
                                    <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem; color: var(--text); font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                        <span data-icon="lock" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>
                                        <span>Secure Files</span>
                                    </h4>
                                    <p style="margin: 0; font-size: 0.75rem; color: var(--text-light);">${files.length} file${files.length !== 1 ? 's' : ''} available for download</p>
                                            </div>
                                <button class="btn btn-primary btn-sm download-all-btn" data-case-id="${caseItem.id}" data-token="${token}" style="font-size: 0.875rem; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span data-icon="document" style="display: inline-block; width: 16px; height: 16px;"></span>
                                    <span>Download All as ZIP</span>
                                </button>
                                        </div>
                            <div class="file-list" style="display: grid; gap: 0.75rem;">
                                ${files.map(file => {
                                    const fileIcon = getFileIcon(file.filename);
                                    const fileSize = formatFileSize(file.size);
                                    return `
                                        <div class="file-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 0.5rem; transition: all 0.2s; color: var(--text);" onmouseover="this.style.boxShadow='0 2px 4px rgba(6,182,212,0.2)'; this.style.borderColor='var(--primary)'" onmouseout="this.style.boxShadow='none'; this.style.borderColor='var(--border)'">
                                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                                <div data-icon="${fileIcon}" style="display: inline-block; width: 32px; height: 32px; vertical-align: middle;"></div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">${escapeHtml(file.originalName)}</div>
                                                    <div style="font-size: 0.75rem; color: var(--text-light);">${fileSize}</div>
                                    </div>
                                            </div>
                                            <a href="${escapeHtml(file.url)}" target="_blank" class="btn btn-secondary btn-sm" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                                                <span data-icon="document" style="display: inline-block; width: 16px; height: 16px;"></span>
                                                <span>Download</span>
                                            </a>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${updates.length > 0 ? `
                        <div class="case-updates" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--text); font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>
                                <span>Activity Feed</span>
                            </h4>
                            <div style="position: relative; padding-left: 2rem;">
                                ${updates.map((update, index) => {
                                    const updateDate = new Date(update.date);
                                    const isLast = index === updates.length - 1;
                                    const icon = getUpdateIcon(update.status);
                                    const statusColor = getStatusColor(update.status);
                                    
                                    return `
                                        <div style="position: relative; padding-bottom: ${isLast ? '0' : '1.5rem'};">
                                            <!-- Timeline Connector -->
                                            ${!isLast ? `<div style="position: absolute; left: -1.5rem; top: 2rem; width: 2px; height: calc(100% - 1rem); background: #e2e8f0;"></div>` : ''}
                                            
                                            <!-- Timeline Dot -->
                                            <div style="position: absolute; left: -1.875rem; top: 0.5rem; width: 1.25rem; height: 1.25rem; border-radius: 50%; background: ${statusColor}; border: 3px solid white; box-shadow: 0 0 0 2px ${statusColor}; z-index: 1;"></div>
                                            
                                            <!-- Update Card -->
                                            <div style="background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.2); color: var(--text);">
                                                <div style="display: flex; align-items: start; gap: 0.75rem;">
                                                    <span data-icon="${icon}" style="display: inline-block; width: 20px; height: 20px; flex-shrink: 0;"></span>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; line-height: 1.5;">${escapeHtml(update.message || update)}</div>
                                                        <div style="font-size: 0.75rem; color: var(--text); opacity: 0.85; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;"><span data-icon="calendar" style="display: inline-block; width: 16px; height: 16px; vertical-align: middle;"></span>${updateDate.toLocaleString('en-US', {
                                                                month: 'short',
                                                                day: 'numeric',
                                                                year: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}</span>
                                                            ${update.status ? `<span style="padding: 0.25rem 0.5rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600;">${update.status}</span>` : ''}
                                    </div>
                                </div>
                        </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : '<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); text-align: center; padding: 1.5rem; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border-radius: 0.5rem;"><p style="margin: 0; color: var(--text); opacity: 0.9;">No updates yet. Check back soon!</p></div>'}
                    
                    <!-- Message Button -->
                    <div style="margin-top: 2rem; display: flex; justify-content: center;">
                        <button class="open-message-btn btn btn-primary" 
                                data-case-id="${safeId}"
                                style="padding: 1rem 2.5rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 700; border-radius: 1rem; box-shadow: 0 6px 20px rgba(30, 64, 175, 0.35); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1rem; letter-spacing: 0.3px; position: relative; overflow: hidden;"
                                onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 24px rgba(30, 64, 175, 0.45)'" 
                                onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 6px 20px rgba(30, 64, 175, 0.35)'">
                            
                            <span>Open Messages</span>
                            ${(() => {
                                // Only count unread admin messages (exclude status changes)
                                const adminMessages = (caseItem.updates || []).filter(u => {
                                    if (!u.message || u.message.includes('Status changed')) return false;
                                    // Check if message is read using the existing clientLastView tracking
                                    const lastReadKey = `clientLastView_${caseItem.id}`;
                                    const lastReadTime = localStorage.getItem(lastReadKey);
                                    if (!lastReadTime) return true; // If never read, it's unread
                                    return new Date(u.date) > new Date(lastReadTime);
                                });
                                const unreadCount = adminMessages.length;
                                return unreadCount > 0 ? `<span class="unread-badge" style="background: #dc2626; color: white; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 800; margin-left: 0.5rem; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4); animation: pulse 2s ease-in-out infinite;">${unreadCount}</span>` : '';
                            })()}
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function downloadAllFiles(caseId, token) {
            try {
                showToast('Preparing download...', 'info');
                const response = await fetch(`${getBackendUrl()}/api/client/cases/${caseId}/download-all?token=${token}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Download failed');
                }
                
                // Use JSZip library or create individual downloads
                if (typeof JSZip !== 'undefined') {
                    const zip = new JSZip();
                    const promises = data.files.map(async (file, index) => {
                        const fileResponse = await fetch(file.url);
                        const blob = await fileResponse.blob();
                        zip.file(file.filename, blob);
                    });
                    
                    await Promise.all(promises);
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(zipBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `case-${caseId}-files.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Files downloaded successfully!', 'success');
                } else {
                    // Fallback: download files individually
                    data.files.forEach((file, index) => {
                        setTimeout(() => {
                            const a = document.createElement('a');
                            a.href = file.url;
                            a.download = file.filename;
                            a.style.display = 'none';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        }, index * 100);
                    });
                    showToast('Downloading files individually...', 'success');
                }
            } catch (error) {
                // Download error (details not exposed)
                showToast('Failed to download files: ' + error.message, 'error');
            }
        };
        
        // Client Reply Handler
        async function handleClientReply(form, e) {
            e.preventDefault();
            const caseId = form.getAttribute('data-case-id');
            const textarea = form.querySelector(`#messageInput-${caseId}`) || form.querySelector(`#modalMessageInput-${caseId}`);
            const charCounter = document.getElementById(`charCounter-${caseId}`) || document.getElementById(`modalCharCounter-${caseId}`);
            const message = textarea?.value.trim();
            const token = new URLSearchParams(window.location.search).get('token');
            const submitBtn = form.querySelector('button[type="submit"]');
            const isModal = form.closest('#messageModal');
            
            if (!message) {
                showToast('Please enter a message', 'error');
                textarea?.focus();
                return;
            }
            
            if (message.length > 1000) {
                showToast('Message is too long (max 1000 characters)', 'error');
                return;
            }
            
            // Disable form during submission
            if (textarea) textarea.disabled = true;
            if (submitBtn) {
                const originalContent = submitBtn.innerHTML;
                submitBtn.disabled = true;
                // Use textContent for safety instead of innerHTML
                submitBtn.innerHTML = '<span class="spinner" style="width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block;"></span> <span>Sending...</span>';
            }
            
            try {
                const response = await fetch(`${getBackendUrl()}/api/client/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, caseId, message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Message sent successfully!', 'success');
                    if (textarea) {
                        textarea.value = '';
                        textarea.style.borderColor = 'var(--border)';
                    }
                    if (charCounter) charCounter.textContent = '0 / 1000';
                    
                    // Reload messages if in modal
                    if (isModal) {
                        // Reload all cases to get updated messages
                        await loadDashboard();
                        // Reopen modal with updated messages
                        openMessageModal(caseId);
                    } else {
                        // Reload dashboard to show new message
                        setTimeout(() => {
        loadDashboard();
                        }, 500);
                    }
                } else {
                    throw new Error(data.error || 'Failed to send message');
                }
            } catch (error) {
                // Log error without exposing sensitive details
                if (process.env.NODE_ENV === 'development') {
                    console.error('Reply error:', error);
                }
                showToast('Failed to send message: ' + (error.message || 'Unknown error'), 'error');
                if (textarea) textarea.disabled = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = isModal ? ' <span>Send</span>' : '<span>ðŸ“¤</span> <span>Send Message</span>';
                }
            }
        }
        
        // Toast Notification Function
        function showToast(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${colors[type] || colors.info};
                color: white;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
                font-weight: 500;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (toast.parentNode) document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // UI Helper Functions
        function showError(message) {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    if (mainContainer) mainContainer.classList.remove('loading');
                }, 300);
            }
            
            document.getElementById('dashboardContainer')?.classList.add('hidden');
            document.getElementById('errorContainer')?.classList.remove('hidden');
            const errorMsgEl = document.getElementById('errorMessage');
            if (errorMsgEl) errorMsgEl.textContent = message;
        }
        
        // Message Modal Functions
        function openMessageModal(caseId) {
            const caseItem = allCases.find(c => c.id === caseId);
            if (!caseItem) return;
            
            // Mark messages as viewed
            const lastViewKey = `clientLastView_${caseId}`;
            localStorage.setItem(lastViewKey, new Date().toISOString());

            const modal = document.getElementById('messageModal');
            const modalBody = document.getElementById('messageModalBody');
            const modalFooter = document.getElementById('messageModalFooter');
            const modalCaseId = document.getElementById('modalCaseId');

            modalCaseId.textContent = `Messages - ${caseId}`;
            
            // Combine all messages
            const allMessages = [];
            
            // Add admin updates that are messages
            if (caseItem.updates && caseItem.updates.length > 0) {
                caseItem.updates.forEach(update => {
                    if (update.message && !update.message.includes('Status changed')) {
                        allMessages.push({
                            ...update,
                            type: 'admin',
                            sender: 'Case Team'
                        });
                    }
                });
            }
            
            // Add client replies
            if (caseItem.clientReplies && caseItem.clientReplies.length > 0) {
                caseItem.clientReplies.forEach(reply => {
                    allMessages.push({
                        ...reply,
                        type: 'client',
                        sender: 'You',
                        date: reply.date
                    });
                });
            }
            
            // Sort by date
            allMessages.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Render messages
            if (allMessages.length === 0) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem;">
                        
                        <p style="margin: 0; color: var(--text-light); font-size: 0.95rem;">No messages yet. Start the conversation below!</p>
                    </div>
                `;
            } else {
                modalBody.innerHTML = `
                    <div class="messages-thread" style="max-height: 400px; overflow-y: auto; padding: 1rem; background: #f8fafc; border-radius: 1rem; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 1rem; scroll-behavior: smooth;">
                        ${allMessages.map((msg, index) => {
                            const msgDate = new Date(msg.date);
                            const isClient = msg.type === 'client';
                            const isFirstOfDay = index === 0 || 
                                new Date(allMessages[index - 1].date).toDateString() !== msgDate.toDateString();
                            
                            return `
                                ${isFirstOfDay ? `
                                    <div style="text-align: center; margin: 0.5rem 0;">
                                        <span style="background: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; color: var(--text-light); border: 1px solid var(--border);">
                                            ${msgDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                                        </span>
                                    </div>
                                ` : ''}
                                <div style="display: flex; ${isClient ? 'justify-content: flex-end;' : 'justify-content: flex-start;'} margin-bottom: ${isFirstOfDay ? '1rem' : '0.5rem'};">
                                    <div style="max-width: 75%; ${isClient ? 'align-items: flex-end;' : 'align-items: flex-start;'} display: flex; flex-direction: column; gap: 0.25rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; ${isClient ? 'flex-direction: row-reverse;' : ''}">
                                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text);">
                                                ${escapeHtml(msg.sender || (isClient ? 'You' : 'Case Team'))}
                                            </span>
                                            ${isClient ? `
                                                <span data-icon="check" style="display: inline-block; width: 16px; height: 16px; opacity: 0.7;"></span>
                                            ` : `
                                                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #3b82f6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.875rem; flex-shrink: 0;">
                                                    ${escapeHtml((msg.sender || 'T')[0].toUpperCase())}
                                                </div>
                                            `}
                                        </div>
                                        <div style="background: ${isClient ? 'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)' : 'white'}; 
                                            color: ${isClient ? 'white' : 'var(--text)'}; 
                                            padding: 0.875rem 1rem; 
                                            border-radius: ${isClient ? '1rem 1rem 0.25rem 1rem' : '1rem 1rem 1rem 0.25rem'}; 
                                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                            word-wrap: break-word;
                                            line-height: 1.5;
                                            white-space: pre-wrap;">
                                            ${escapeHtml(msg.message)}
                                        </div>
                                        <span style="font-size: 0.7rem; color: var(--text-light); padding: 0 0.5rem; ${isClient ? 'text-align: right;' : 'text-align: left;'}">
                                            ${msgDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                // Auto-scroll to bottom
                setTimeout(() => {
                    const thread = modalBody.querySelector('.messages-thread');
                    if (thread) thread.scrollTop = thread.scrollHeight;
                }, 100);
            }
            
            // Render message input form
            // Escape caseId for use in attributes
            const safeCaseId = escapeHtml(caseId);
            modalFooter.innerHTML = `
                <form class="client-reply-form" data-case-id="${safeCaseId}" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="position: relative;">
                        <textarea 
                            id="modalMessageInput-${safeCaseId}"
                            placeholder="Type your message here..." 
                            required 
                            style="width: 100%; min-height: 100px; max-height: 150px; padding: 1rem; padding-right: 4rem; border: 2px solid var(--border); border-radius: 0.75rem; font-family: inherit; resize: vertical; font-size: 0.95rem; line-height: 1.5; transition: all 0.2s;"
                            oninput="this.style.borderColor = this.value.trim() ? 'var(--primary)' : 'var(--border)'; const counter = document.getElementById('modalCharCounter-${safeCaseId}'); if (counter) counter.textContent = this.value.length + ' / 1000';"
                        ></textarea>
                        <div id="modalCharCounter-${safeCaseId}" style="position: absolute; bottom: 0.75rem; right: 3.5rem; font-size: 0.7rem; color: var(--text-light); pointer-events: none;">0 / 1000</div>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-light);">
                            
                            <span>Encrypted & secure</span>
                        </div>
                        <button type="submit" class="btn btn-primary" style="padding: 0.75rem 2rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; border-radius: 0.75rem;">
                            <span>ðŸ“¤</span>
                            <span>Send</span>
                        </button>
                    </div>
                </form>
            `;
            
            modal.classList.add('active');
            
            // Mark messages as read when modal opens (using existing tracking)
            const lastReadKey = `clientLastView_${caseId}`;
            localStorage.setItem(lastReadKey, new Date().toISOString());
            
            // Update the badge count in the button - remove unread badge
            setTimeout(() => {
                const messageBtn = document.querySelector(`button.open-message-btn[data-case-id="${caseId}"]`);
                if (messageBtn) {
                    const badge = messageBtn.querySelector('.unread-badge');
                    if (badge) {
                        badge.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => badge.remove(), 300);
                    }
                }
            }, 100);
            
            // Focus textarea
            setTimeout(() => {
                const textarea = document.getElementById(`modalMessageInput-${caseId}`);
                if (textarea) textarea.focus();
            }, 300);
        }
        
        function closeMessageModal() {
            const modal = document.getElementById('messageModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // Make function globally accessible
        window.closeMessageModal = closeMessageModal;
        
        // Close modal on close button click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('close-message-modal') || e.target.closest('.close-message-modal') || e.target.id === 'closeMessageBtn') {
                closeMessageModal();
            }
        });
        
        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('messageModal');
            if (e.target === modal) {
                closeMessageModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMessageModal();
            }
        });
        
        // Event Listeners
        document.addEventListener('submit', (e) => {
            if (e.target.classList.contains('client-reply-form')) {
                handleClientReply(e.target, e);
            }
        });
        
        // Open message modal button handlers
        document.addEventListener('click', (e) => {
            if (e.target.closest('.open-message-btn')) {
                const btn = e.target.closest('.open-message-btn');
                const caseId = btn.getAttribute('data-case-id');
                if (caseId) {
                    openMessageModal(caseId);
                }
            }
        });
        
        // Inquiry Form Modal Functions
        function openInquiryModal() {
            const modal = document.getElementById('inquiryModal');
            if (modal) {
                modal.classList.add('active');
                // Pre-fill email if available from current cases
                const firstCase = allCases[0];
                if (firstCase && firstCase.email) {
                    const emailInput = document.getElementById('inquiryEmail');
                    if (emailInput) emailInput.value = firstCase.email;
                }
                // Focus first input
                setTimeout(() => {
                    const nameInput = document.getElementById('inquiryName');
                    if (nameInput) nameInput.focus();
                }, 300);
            }
        }
        
        function closeInquiryModal() {
            const modal = document.getElementById('inquiryModal');
            if (modal) {
                modal.classList.remove('active');
                // Reset form
                const form = document.getElementById('clientInquiryForm');
                if (form) {
                    form.reset();
                    document.getElementById('inquiryFileList').textContent = 'No files selected';
                    document.getElementById('inquiryFormStatus').style.display = 'none';
                    document.getElementById('inquiryFormStatus').textContent = '';
                }
            }
        }
        
        window.closeInquiryModal = closeInquiryModal;
        
        // Open inquiry modal button handlers
        document.addEventListener('click', (e) => {
            if (e.target.id === 'openInquiryFormBtn' || e.target.id === 'openInquiryFormBtnEmpty' || e.target.closest('#openInquiryFormBtn') || e.target.closest('#openInquiryFormBtnEmpty')) {
                openInquiryModal();
            }
            if (e.target.id === 'closeInquiryBtn' || e.target.id === 'cancelInquiryBtn' || e.target.closest('#closeInquiryBtn') || e.target.closest('#cancelInquiryBtn')) {
                closeInquiryModal();
            }
        });
        
        // Close inquiry modal on overlay click
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('inquiryModal');
            if (e.target === modal) {
                closeInquiryModal();
            }
        });
        
        // Close inquiry modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const inquiryModal = document.getElementById('inquiryModal');
                if (inquiryModal && inquiryModal.classList.contains('active')) {
                    closeInquiryModal();
                }
            }
        });
        
        // Handle file input changes
        document.addEventListener('change', (e) => {
            if (e.target.id === 'inquiryFileInput') {
                const files = Array.from(e.target.files);
                const fileList = document.getElementById('inquiryFileList');
                if (files.length === 0) {
                    fileList.textContent = 'No files selected';
                } else {
                    const fileNames = files.map(f => f.name).join(', ');
                    fileList.textContent = `Selected: ${files.length} file(s) - ${fileNames}`;
                }
            }
        });
        
        // Handle inquiry form submission
        document.addEventListener('submit', async (e) => {
            if (e.target.id === 'clientInquiryForm') {
                e.preventDefault();
                
                const form = e.target;
                const submitBtn = document.getElementById('submitInquiryBtn');
                const submitText = document.getElementById('submitInquiryText');
                const submitLoading = document.getElementById('submitInquiryLoading');
                const statusDiv = document.getElementById('inquiryFormStatus');
                
                // Validate files
                const fileInput = document.getElementById('inquiryFileInput');
                const files = Array.from(fileInput.files);
                const maxSize = 10 * 1024 * 1024; // 10MB
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'text/plain', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                
                for (let file of files) {
                    if (file.size > maxSize) {
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'form-status status-error';
                        statusDiv.textContent = `File "${file.name}" exceeds 10MB limit`;
                        return;
                    }
                    if (!allowedTypes.includes(file.type)) {
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'form-status status-error';
                        statusDiv.textContent = `File type not supported: "${file.name}"`;
                        return;
                    }
                }
                
                // Show loading state
                submitBtn.disabled = true;
                submitText.style.display = 'none';
                submitLoading.style.display = 'inline-block';
                statusDiv.style.display = 'none';
                
                try {
                    const formData = new FormData(form);
                    files.forEach(file => {
                        formData.append('files', file);
                    });
                    
                    const response = await fetch(`${getBackendUrl()}/api/contact`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'form-status status-success';
                        statusDiv.textContent = `Case ${data.caseId} submitted successfully! We've sent a confirmation email. Our team will contact you within 24-48 hours.`;
                        
                        // Reset form
                        form.reset();
                        document.getElementById('inquiryFileList').textContent = 'No files selected';
                        
                        // Reload dashboard after 2 seconds
                        setTimeout(async () => {
                            await loadDashboard();
                            closeInquiryModal();
                            showToast('Your new case has been added to your dashboard!', 'success');
                        }, 2000);
                    } else {
                        throw new Error(data.error || 'Submission failed');
                    }
                } catch (error) {
                    // Inquiry submission error (details not exposed)
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'form-status status-error';
                    statusDiv.textContent = `Submission failed: ${error.message}. Please try again.`;
                } finally {
                    submitBtn.disabled = false;
                    submitText.style.display = 'inline-block';
                    submitLoading.style.display = 'none';
                }
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>

