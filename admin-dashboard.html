<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sleuthservice</title>
    <link rel="stylesheet" href="styles.css">
    <script src="icons.js" defer></script>
    <script src="siteConfig.js" defer></script>
    <script src="ui.js" defer></script>
    <style>
        .admin-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-attachment: fixed;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: white;
            padding: 1.25rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 3px solid #06b6d4;
            position: relative;
            overflow: hidden;
        }
        
        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #06b6d4, #3b82f6, #8b5cf6, #ec4899, #06b6d4);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
            pointer-events: none;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .admin-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(6, 182, 212, 0.3);
        }
        
        .admin-nav {
            display: flex;
            gap: 1rem;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .admin-nav button {
            padding: 0.625rem 1.25rem;
            background: rgba(6, 182, 212, 0.15);
            border: 1.5px solid rgba(6, 182, 212, 0.3);
            border-radius: 0.75rem;
            color: #06b6d4;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .admin-nav button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.2), transparent);
            transition: left 0.5s;
            pointer-events: none;
        }
        
        .admin-nav button:hover::before {
            left: 100%;
        }
        
        .admin-nav button:hover {
            background: rgba(6, 182, 212, 0.25);
            border-color: #06b6d4;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
            color: #22d3ee;
        }
        
        .admin-nav button.active {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            border-color: #06b6d4;
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.5);
        }
        
        .admin-nav button [data-icon] {
            display: inline-block !important;
            width: 18px !important;
            height: 18px !important;
            vertical-align: middle !important;
            color: white !important;
            fill: none !important;
            stroke: white !important;
        }
        
        .admin-nav button [data-icon] svg {
            width: 18px !important;
            height: 18px !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: white !important;
        }
        
        .admin-nav button [data-icon] svg path,
        .admin-nav button [data-icon] svg circle,
        .admin-nav button [data-icon] svg rect,
        .admin-nav button [data-icon] svg line {
            stroke: white !important;
            fill: none !important;
        }
        
        .admin-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            padding: 1.75rem;
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-top: 3px solid #06b6d4;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s ease-out;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #06b6d4, #3b82f6, #8b5cf6);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s;
            pointer-events: none;
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-card:hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 16px 40px rgba(6, 182, 212, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: #06b6d4;
            border-top-width: 4px;
        }
        
        .stat-card h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin: 0 0 0.75rem 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }
        
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }
        
        .cases-table {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .cases-table:hover {
            box-shadow: 0 12px 40px rgba(6, 182, 212, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: rgba(6, 182, 212, 0.4);
        }
        
        .cases-table tr {
            transition: all 0.2s ease;
        }
        
        .cases-table tr:hover {
            background: rgba(30, 64, 175, 0.05);
            transform: scale(1.01);
        }
        
        button, .btn, a[style*="background"] {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover, .btn:hover, a[style*="background"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.35) !important;
        }
        
        .cases-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .cases-table th {
            background: rgba(15, 23, 42, 0.6);
            padding: 1.25rem 1rem;
            text-align: left;
            font-weight: 700;
            color: #06b6d4;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            border-bottom: 2px solid rgba(6, 182, 212, 0.3);
        }
        
        .cases-table td {
            padding: 1.25rem 1rem;
            border-top: 1px solid rgba(6, 182, 212, 0.1);
            color: #e2e8f0;
        }
        
        .cases-table tr:hover {
            background: rgba(6, 182, 212, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-new { background: #fef3c7; color: #92400e; }
        .status-in-progress { background: #fed7aa; color: #c2410c; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-on-hold { background: #f3f4f6; color: #374151; }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        #emailPreviewModal {
            z-index: 1001;
        }
        
        /* When webmail modal has preview showing on top, dim its background */
        #webmailModal.has-preview {
            background: rgba(0,0,0,0.8) !important;
        }
        
        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 800px;
            max-height: 90vh;
            border: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: white;
            overflow-y: auto;
            margin: 2rem;
            position: relative;
            z-index: 1;
            pointer-events: auto;
        }
        
        .modal-content * {
            pointer-events: auto;
        }
        
        #emailPreviewModal .modal-content {
            z-index: 2;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h2 {
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            color: #e2e8f0;
            transform: scale(1.1);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 0.5rem;
            font-size: 1rem;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            font-family: inherit;
            transition: all 0.3s ease;
            pointer-events: auto;
            cursor: text;
            -webkit-user-select: text;
            user-select: text;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
            background: rgba(15, 23, 42, 0.95);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #6b7280 !important;
            opacity: 1 !important;
        }
        
        .form-group input[readonly] {
            background: rgba(15, 23, 42, 0.5);
            cursor: not-allowed;
        }
        
        .form-group select {
            cursor: pointer;
        }
        
        .form-group select option {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Ensure all form elements are interactive */
        input, textarea, select, button {
            pointer-events: auto !important;
        }
        
        /* Ensure forms themselves are interactive */
        form {
            pointer-events: auto !important;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 30%, #334155 60%, #1e293b 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            overflow: hidden;
        }
        
        .login-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.5;
            pointer-events: none;
        }
        
        .login-box {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(30px);
            padding: 3rem;
            border-radius: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            max-width: 450px;
            width: 100%;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.6s ease-out;
            color: white;
            pointer-events: auto;
        }
        
        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #06b6d4, #3b82f6, #8b5cf6);
            border-radius: 2rem 2rem 0 0;
            pointer-events: none;
        }
        
        .login-box h2 {
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-box .form-group {
            margin-bottom: 1.5rem;
        }
        
group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
            transform: translateY(-2px);
        }
        
        .login-box .form-group {
            position: relative;
        }
        
        .login-box .form-group::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 2.75rem;
            font-size: 1.2rem;
            pointer-events: none;
            color: var(--text-light);
        }
        
        .login-box .form-group:last-of-type::before {
            content: '';
        }
        
        .login-box .btn-primary {
            width: 100%;
            padding: 1.125rem 2rem;
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }
        
        .login-box .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .login-box .btn-primary:hover::before {
            left: 100%;
        }
        
        .login-box .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6);
            background: linear-gradient(135deg, #22d3ee 0%, #60a5fa 100%);
        }
        
        .login-box .btn-primary:active {
            transform: translateY(0);
        }
        
        .login-box input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: white;
        }
        
        .login-box input:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
        }
        
        .login-box label {
            color: #cbd5e1;
        }
        
        .hidden {
            display: none;
        }
        
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2><span data-icon="lock" style="display: inline-block; width: 24px; height: 24px; vertical-align: middle; margin-right: 0.5rem;"></span>Admin Login</h2>
            <p style="text-align: center; color: #94a3b8; margin-bottom: 2rem;" data-company-name>Sleuthservice - Admin Dashboard</p>
            <div id="loginError" role="alert" aria-live="polite" aria-atomic="true" style="display: none; background: rgba(220, 38, 38, 0.1); color: #dc2626; padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem; border: 2px solid rgba(220, 38, 38, 0.2);"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" name="email" value="admin@sleuthservice.com" placeholder="admin@sleuthservice.com" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginSubmitBtn">
                    <span id="loginBtnText">Sign In</span>
                    <span id="loginBtnSpinner" style="display: none;" class="spinner"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container" style="display: none;">
        <div class="admin-header">
            <div class="admin-header-content">
                <h1 data-company-name>Sleuthservice - Admin Dashboard</h1>
                <div class="admin-nav">
                    <button id="messagesNavBtn"><span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; margin-right: 0.5rem; color: white;"></span>Messages</button>
                    <button id="casesNavBtn" class="active"><span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; margin-right: 0.5rem; color: white;"></span>Cases</button>
                    <button id="logoutBtn"><span data-icon="lock" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; margin-right: 0.5rem; color: white;"></span>Logout</button>
                </div>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- Messages View -->
            <div id="messagesView" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0;">All Client Messages</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="messagesSearch" placeholder="Search messages..." style="padding: 0.75rem; border: 2px solid rgba(6, 182, 212, 0.3); border-radius: 0.5rem; width: 300px; background: rgba(15, 23, 42, 0.8); color: #e2e8f0;">
                        <select id="messagesFilter" style="padding: 0.75rem; border: 2px solid rgba(6, 182, 212, 0.3); border-radius: 0.5rem; background: rgba(15, 23, 42, 0.8); color: #e2e8f0;">
                            <option value="all">All Messages</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
                
                <div id="messagesContainer" style="display: grid; gap: 1rem;">
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 0.75rem; box-shadow: var(--shadow);">
                        <p>Loading messages...</p>
                    </div>
                </div>
            </div>
            
            <!-- Cases View -->
            <div id="casesView">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Cases</h3>
                    <div class="value" id="totalCases">0</div>
                </div>
                <div class="stat-card">
                    <h3>New Cases</h3>
                    <div class="value" id="newCases">0</div>
                </div>
                <div class="stat-card">
                    <h3>In Progress</h3>
                    <div class="value" id="inProgressCases">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="value" id="completedCases">0</div>
                </div>
            </div>
            
            <!-- Filters and Search Bar -->
            <div style="background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px); padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1); border: 1px solid rgba(6, 182, 212, 0.3); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: #e2e8f0;"><span data-icon="search" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; color: #06b6d4;"></span>Search Cases</label>
                        <input type="text" id="searchInput" placeholder="Search by ID, name, email, or service..." style="margin: 0; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; border: 2px solid rgba(6, 182, 212, 0.3);">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: #e2e8f0;"><span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; color: #06b6d4;"></span>Status</label>
                        <select id="statusFilter" style="margin: 0; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; border: 2px solid rgba(6, 182, 212, 0.3);">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: #e2e8f0;"><span data-icon="calendar" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; color: #06b6d4;"></span>Start Date</label>
                        <input type="date" id="startDateFilter" style="margin: 0; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; border: 2px solid rgba(6, 182, 212, 0.3);">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: #e2e8f0;"><span data-icon="calendar" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; color: #06b6d4;"></span>End Date</label>
                        <input type="date" id="endDateFilter" style="margin: 0; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; border: 2px solid rgba(6, 182, 212, 0.3);">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: #e2e8f0;"><span data-icon="refresh" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; color: #06b6d4;"></span>Sort By</label>
                        <select id="sortSelect" style="margin: 0; background: rgba(15, 23, 42, 0.8); color: #e2e8f0; border: 2px solid rgba(6, 182, 212, 0.3);">
                            <option value="createdAt-desc">Newest First</option>
                            <option value="createdAt-asc">Oldest First</option>
                            <option value="updatedAt-desc">Recently Updated</option>
                            <option value="status-asc">Status (A-Z)</option>
                            <option value="name-asc">Name (A-Z)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" id="applyFiltersBtn" style="padding: 0.75rem 1.5rem;">Apply</button>
                        <button class="btn btn-secondary" id="clearFiltersBtn" style="padding: 0.75rem 1.5rem;">Clear</button>
                        <button class="btn btn-primary" id="exportCSVBtn" style="padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 0.5rem;"><span data-icon="document" style="display: inline-block; width: 18px; height: 18px;"></span>Export CSV</button>
                    </div>
                </div>
            </div>
            
            <div class="cases-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 150px;">Case ID</th>
                            <th>Client</th>
                            <th>Email</th>
                            <th>Service</th>
                            <th style="width: 150px;">Status</th>
                            <th style="width: 130px;">Created</th>
                            <th style="width: 130px;">Last Updated</th>
                            <th style="width: 80px; text-align: center;">Messages</th>
                            <th style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="casesTable">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem;">
                                Loading cases...
                            </td>
                        </tr>
                    </tbody>
                </table>
                <!-- Pagination -->
                <div id="paginationControls" style="padding: 1.5rem; display: none; justify-content: space-between; align-items: center; border-top: 1px solid var(--border);">
                    <div>
                        <span id="paginationInfo">Showing 0-0 of 0 cases</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" id="prevPageBtn" data-direction="-1" disabled>← Previous</button>
                        <span id="pageInfo" style="padding: 0.5rem 1rem; display: flex; align-items: center;">Page 1</span>
                        <button class="btn btn-secondary" id="nextPageBtn" data-direction="1" disabled>Next →</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
    
    <!-- View Case Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>Case Details</h2>
                <button class="close-btn" id="closeViewModalBtn">&times;</button>
            </div>
            <div id="viewModalContent">
                <p>Loading...</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="editFromViewBtn">Edit Case</button>
                <button class="btn btn-secondary" id="sendEmailFromViewBtn" style="display: flex; align-items: center; gap: 0.5rem;"><span data-icon="email" style="display: inline-block; width: 18px; height: 18px;"></span>Send Email</button>
                <button class="btn btn-secondary" id="closeViewBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div id="emailPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 950px;">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <span data-icon="document" style="display: inline-block; width: 24px; height: 24px; vertical-align: middle;"></span>
                    <span>Email Preview</span>
                </h2>
                <button class="close-btn" id="closePreviewBtn">&times;</button>
            </div>
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                <div id="emailPreviewMeta" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;"></div>
            </div>
            <div id="emailPreviewContent" style="background: white; border-radius: 8px; max-height: 65vh; overflow-y: auto; border: 1px solid #e2e8f0;"></div>
            <div class="modal-actions" style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" id="backToEditorBtn">← Back to Editor</button>
            </div>
        </div>
    </div>

    <!-- Admin Chat Modal -->
    <div id="adminChatModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <span data-icon="document" style="display: inline-block; width: 24px; height: 24px; vertical-align: middle;"></span>
                    <span id="adminChatCaseId">Chat</span>
                </h2>
                <button class="close-btn" id="closeAdminChatBtn">&times;</button>
            </div>
            <div id="adminChatMessages" style="flex: 1; overflow-y: auto; padding: 1.5rem; background: rgba(15, 23, 42, 0.6); border-top: 1px solid rgba(6, 182, 212, 0.2); border-bottom: 1px solid rgba(6, 182, 212, 0.2); display: flex; flex-direction: column; gap: 1rem; min-height: 300px; max-height: 500px;">
                <!-- Messages will be loaded here -->
            </div>
            <div style="padding: 1.5rem; background: rgba(30, 41, 59, 0.8); flex-shrink: 0; border-top: 1px solid rgba(6, 182, 212, 0.2);">
                <form id="adminChatForm" style="display: flex; flex-direction: column; gap: 1rem;">
                    <textarea id="adminChatMessage" placeholder="Type your message here..." rows="3" required></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <small style="color: #94a3b8; font-size: 0.8rem;" id="adminChatCharCount">0 / 1000</small>
                        <button type="submit" class="btn btn-primary" style="padding: 0.75rem 2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span data-icon="email" style="display: inline-block; width: 18px; height: 18px;"></span>
                            <span>Send Message</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Webmail Modal -->
    <div id="webmailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <span data-icon="email" style="display: inline-block; width: 24px; height: 24px; vertical-align: middle;"></span>
                    <span>Compose Email</span>
                </h2>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button type="button" class="btn btn-secondary" id="previewEmailBtn" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        <span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span> Preview
                    </button>
                    <button class="close-btn" id="closeWebmailBtn">&times;</button>
                </div>
            </div>
            <form id="webmailForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;"><span data-icon="email" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>To (Required)</label>
                        <input type="email" id="webmailTo" placeholder="client@example.com" required>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;"><span data-icon="warning" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>Priority</label>
                        <select id="emailPriority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;"><span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>CC (Optional)</label>
                    <input type="email" id="webmailCc" placeholder="additional@example.com">
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;"><span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>Subject</label>
                    <input type="text" id="webmailSubject" placeholder="Enter email subject..." required>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;"><span data-icon="document" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>Quick Templates</span>
                        <select id="emailTemplate" style="width: auto; padding: 0.5rem;">
                            <option value="">Select a template...</option>
                            <option value="welcome">Welcome</option>
                            <option value="update">Update</option>
                            <option value="completion">Completed</option>
                            <option value="info">Info Request</option>
                        </select>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="webmailMessage" placeholder="Type your email message here..." rows="12" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Case Reference (Optional)</label>
                    <input type="text" id="webmailCaseId" placeholder="e.g., C-MH1AS9S22M2L">
                    <small style="color: #94a3b8; font-size: 0.875rem;">This will add a reference link to the case in the email</small>
                </div>
                
                <div class="modal-actions" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" id="sendEmailBtn">
                        <span class="btn-text" style="display: flex; align-items: center; gap: 0.5rem;"><span data-icon="email" style="display: inline-block; width: 18px; height: 18px;"></span>Send Email</span>
                        <span class="btn-loading">Sending...</span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelWebmailBtn">Cancel</button>
                </div>
            </form>
            <div id="webmailStatus" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Edit Case Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Case</h2>
                <button class="close-btn" id="closeEditModalBtn">&times;</button>
            </div>
            <form id="editCaseForm">
                <div class="form-group">
                    <label>Case ID</label>
                    <input type="text" id="editCaseId" readonly>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="new">New</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Add Note/Update</label>
                    <textarea id="editNotes" placeholder="Add case notes or updates..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        /**
         * admin-dashboard.html - Admin Dashboard JavaScript
         * 
         * This script handles:
         * - Admin authentication and login
         * - Case management (view, filter, search, update)
         * - Message management and client communication
         * - File downloads and case exports
         * - Real-time case status updates
         * - Pagination and sorting
         * 
         * All API calls use JWT token authentication stored in localStorage.
         */
        
        // ========================================================================
        // CONFIGURATION & STATE MANAGEMENT
        // ========================================================================
        
        /**
         * Authentication Token
         * Stored in localStorage and used for all authenticated API requests
         */
        let authToken = null;
        
        /**
         * getBackendUrl()
         * 
         * Automatically detects the correct backend URL based on the current page location.
         * - If running on localhost, uses the same port as the current page
         * - If running on production domain, uses same origin
         * 
         * @returns {string} - Backend API base URL
         */
        const getBackendUrl = () => {
            const hostname = window.location.hostname;
            const port = window.location.port || '3001';  // Default to 3001 (HTTP port)
            
            // Check if running locally
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '') {
                // Use the same port as the current page for consistency
                return `http://localhost:${port}`;
            }
            
            // Production: use same origin (backend should be on same domain/port)
            const protocol = window.location.protocol;
            return `${protocol}//${hostname}${port ? ':' + port : ''}`;
        };
        
        // Set the API base URL once on page load
        const API_BASE_URL = getBackendUrl();
        console.log('Using backend URL:', API_BASE_URL);
        
        // ========================================================================
        // APPLICATION STATE
        // ========================================================================
        
        /**
         * casesData - Array of all loaded cases
         * Updated when cases are fetched from the API
         */
        let casesData = [];
        
        /**
         * currentCase - Currently selected/viewing case
         * Set when user clicks on a case to view details
         */
        let currentCase = null;
        
        /**
         * paginationData - Pagination metadata from API
         * Contains: totalPages, currentPage, hasNextPage, hasPrevPage, etc.
         */
        let paginationData = null;
        
        /**
         * currentFilters - Active filter and sort settings
         * Used to maintain filter state when reloading cases
         */
        let currentFilters = {
            search: '',           // Text search query
            status: '',           // Case status filter (new, in-progress, etc.)
            startDate: '',        // Filter cases from this date
            endDate: '',          // Filter cases until this date
            sortBy: 'createdAt',  // Field to sort by
            sortOrder: 'desc',    // Sort direction (asc/desc)
            page: 1,              // Current page number
            limit: 20             // Cases per page
        };
        
        /**
         * allMessages - All messages from all cases
         * Used in the messages view to show all client communications
         */
        let allMessages = [];

        // Helper function to show login screen
        function showLogin() {
            const loginScreen = document.getElementById('loginScreen');
            const adminDashboard = document.getElementById('adminDashboard');
            
            if (loginScreen) {
                loginScreen.style.display = 'flex';
                loginScreen.classList.remove('hidden');
            }
            if (adminDashboard) {
                adminDashboard.style.display = 'none';
                adminDashboard.classList.add('hidden');
            }
            
            // Focus email field
            const emailField = document.getElementById('loginEmail');
            if (emailField) {
                setTimeout(() => emailField.focus(), 100);
            }
        }
        
        function showDashboard() {
            console.log('showDashboard called');
            const loginScreen = document.getElementById('loginScreen');
            const adminDashboard = document.getElementById('adminDashboard');
            
            if (loginScreen) {
                loginScreen.style.display = 'none';
                loginScreen.classList.add('hidden');
            }
            if (adminDashboard) {
                adminDashboard.style.display = 'block';
                adminDashboard.classList.remove('hidden');
            }
            
            // Navigation buttons are handled by event delegation in initDashboardComponents()
        }
        
        // Make functions globally accessible
        window.showLogin = showLogin;
        window.showDashboard = showDashboard;
        
        window.logout = function() {
            console.log('Logout function called');
            
            // Clear all authentication data
            localStorage.removeItem('adminToken');
            authToken = null;
            casesData = [];
            currentCase = null;
            sessionStorage.clear();
            
            // Show login screen using helper function
            showLogin();
            
            // Reset login form and button state
            const loginForm = document.getElementById('loginForm');
            const passwordField = document.getElementById('loginPassword');
            const submitBtn = document.getElementById('loginSubmitBtn');
            const btnText = document.getElementById('loginBtnText');
            const btnSpinner = document.getElementById('loginBtnSpinner');
            const errorDiv = document.getElementById('loginError');
            
            // Reset form
            if (loginForm && passwordField) {
                passwordField.value = '';
            }
            
            // Reset button state - ensure it's ready for login
            if (submitBtn) {
                submitBtn.disabled = false;
            }
            if (btnText) {
                btnText.textContent = 'Sign In';
                btnText.style.display = 'inline';
            }
            if (btnSpinner) {
                btnSpinner.style.display = 'none';
            }
            
            // Reset error display
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            console.log('Logged out - showing login screen');
        };

        window.openEditModal = function(caseId) {
            console.log('Opening edit modal for case:', caseId);
            currentCase = casesData.find(c => c.id === caseId);
            if (!currentCase) {
                alert('Case not found');
                return;
            }

            document.getElementById('editCaseId').value = currentCase.id;
            document.getElementById('editStatus').value = currentCase.status;
            document.getElementById('editNotes').value = '';
            document.getElementById('editModal').classList.add('active');
            console.log('Edit modal opened successfully');
        };

        window.closeModal = function() {
            document.getElementById('editModal').classList.remove('active');
            currentCase = null;
        };

        // Define closeModal function for local scope
        function closeModal() {
            window.closeModal();
        }

        window.viewCaseDetails = function(caseId) {
            console.log('Viewing case details for:', caseId);
            const caseItem = casesData.find(c => c.id === caseId);
            if (!caseItem) {
                alert('Case not found');
                return;
            }

            const statusColors = {
                'new': '#f59e0b',
                'in-progress': '#a855f7',
                'completed': '#10b981',
                'on-hold': '#6b7280'
            };

            const createdAt = new Date(caseItem.createdAt).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const updatesHtml = caseItem.updates && caseItem.updates.length > 0 ? `
                <div style="margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text); font-weight: 600;">Activity Feed</h4>
                    <div style="position: relative; padding-left: 2rem;">
                        ${caseItem.updates.map((u, index) => {
                            const updateDate = new Date(u.date);
                            const isLast = index === caseItem.updates.length - 1;
                            const iconMap = {
                                'new': 'document',
                                'in-progress': 'refresh',
                                'completed': 'success',
                                'on-hold': 'warning',
                                'default': 'document'
                            };
                            const icon = iconMap[u.status] || iconMap['default'];
                            
                            return `
                                <div style="position: relative; padding-bottom: ${isLast ? '0' : '1.5rem'};">
                                    <!-- Timeline Connector -->
                                    ${!isLast ? `<div style="position: absolute; left: -1.5rem; top: 2rem; width: 2px; height: calc(100% - 1rem); background: #e2e8f0;"></div>` : ''}
                                    
                                    <!-- Timeline Dot -->
                                    <div style="position: absolute; left: -1.875rem; top: 0.5rem; width: 1.25rem; height: 1.25rem; border-radius: 50%; background: ${statusColors[u.status] || '#6b7280'}; border: 3px solid white; box-shadow: 0 0 0 2px ${statusColors[u.status] || '#6b7280'}; z-index: 1;"></div>
                                    
                                    <!-- Update Card -->
                                    <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <div style="display: flex; align-items: start; gap: 0.75rem; margin-bottom: 0.5rem;">
                                            <span data-icon="${icon}" style="display: inline-block; width: 20px; height: 20px;"></span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">${escapeHtml(u.message)}</div>
                                                <div style="font-size: 0.75rem; color: #64748b; display: flex; align-items: center; gap: 0.75rem;">
                                                    <span style="display: inline-flex; align-items: center; gap: 0.5rem;"><span data-icon="calendar" style="display: inline-block; width: 16px; height: 16px; vertical-align: middle;"></span>${updateDate.toLocaleString('en-US', {
                                                        month: 'short',
                                                        day: 'numeric',
                                                        year: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    })}</span>
                                                    ${u.status ? `<span style="padding: 0.25rem 0.5rem; background: ${statusColors[u.status] || '#e5e7eb'}20; color: ${statusColors[u.status] || '#6b7280'}; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600;">${escapeHtml(u.status)}</span>` : ''}
                            </div>
                        </div>
                </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '<div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 0.5rem; border: 1px dashed var(--border);"><p style="margin: 0; color: #94a3b8;">No updates yet</p></div>';

            const filesHtml = caseItem.files && caseItem.files.length > 0 ? `
                <div style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 1rem; color: var(--text); font-weight: 600;">Attachments Upload File</h4>
                        <span style="font-size: 0.875rem; color: var(--text-light);">${caseItem.files.length} file(s)</span>
                            </div>
                    <div style="display: grid; gap: 0.75rem;">
                        ${caseItem.files.map(f => {
                            const fileIcon = f.filename.match(/\.(pdf)$/i) ? 'document' : 
                                           f.filename.match(/\.(jpg|jpeg|png|gif)$/i) ? 'document' : 
                                           f.filename.match(/\.(xlsx|xls|csv)$/i) ? 'document' : 'document';
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border: 1px solid var(--border); border-radius: 0.5rem; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                    <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                        <div data-icon="${fileIcon}" style="display: inline-block; width: 32px; height: 32px; vertical-align: middle;"></div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">${escapeHtml((f.originalName || f.filename).length > 30 ? (f.originalName || f.filename).substring(0, 30) + '...' : (f.originalName || f.filename))}</div>
                                            <div style="font-size: 0.75rem; color: #64748b;">${(f.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                </div>
                                    <a href="${escapeHtml(f.url)}" target="_blank" class="btn btn-secondary btn-sm" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>⬇️</span>
                                        <span>Download</span>
                                    </a>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '<div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 0.5rem; border: 1px dashed var(--border);"><p style="margin: 0; color: #94a3b8;">No files attached</p></div>';

            // Enhanced Case Details View with Tabs and Cards (matching design)
            document.getElementById('viewModalContent').innerHTML = `
                <!-- Case Header -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h2 style="margin: 0 0 0.25rem 0; font-size: 1.5rem; color: var(--text);">Case ${escapeHtml(caseItem.id)}</h2>
                            <p style="margin: 0; color: var(--text-light); font-size: 1rem;">${escapeHtml(caseItem.service || 'General Inquiry')}</p>
                    </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div>
                                <span style="font-size: 0.875rem; color: var(--text-light); margin-right: 0.5rem;">Status:</span>
                                <span class="status-badge status-${escapeHtml(caseItem.status)}">${escapeHtml(caseItem.status)}</span>
                    </div>
                    </div>
                    </div>
                </div>

                <!-- Client and Service Details Cards -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <!-- Client Details Card -->
                    <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border);">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Client Details</div>
                                <div style="font-weight: 700; font-size: 1.125rem; color: var(--text); margin-bottom: 0.75rem;">${escapeHtml(caseItem.name || 'N/A')}</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                    <a href="mailto:${escapeHtml(caseItem.email || '')}" style="color: var(--primary); text-decoration: none;">${escapeHtml(caseItem.email || 'N/A')}</a>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                    <span>${escapeHtml(caseItem.phone || 'N/A')}</span>
                                </div>
                            </div>
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #a855f7, #7c3aed); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.5rem; flex-shrink: 0;">
                                ${escapeHtml((caseItem.name || 'C')[0].toUpperCase())}
                            </div>
                        </div>
                </div>

                    <!-- Service Details Card -->
                    <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border);">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Service Details</div>
                                <div style="font-weight: 700; font-size: 1.125rem; color: var(--text); margin-bottom: 0.75rem;">${escapeHtml(caseItem.service || 'General Inquiry')}</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                    <span>Start Date: ${new Date(caseItem.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                                    <span>Last Updated: ${new Date(caseItem.updatedAt || caseItem.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                </div>
                            </div>
                            <div style="width: 60px; height: 60px; border-radius: 0.5rem; background: linear-gradient(135deg, #ede9fe, #ddd6fe); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 2rem;">
                                
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div style="border-bottom: 2px solid var(--border); margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="case-tab-btn active" data-tab="details" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: 600; cursor: pointer; font-size: 0.875rem;">Case Details</button>
                        <button class="case-tab-btn" data-tab="timeline" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-light); font-weight: 500; cursor: pointer; font-size: 0.875rem;">Updates & Timeline</button>
                        <button class="case-tab-btn" data-tab="email" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-light); font-weight: 500; cursor: pointer; font-size: 0.875rem;">Email Composer</button>
                    </div>
                </div>

                <!-- Tab Content: Case Details -->
                <div id="caseDetailsTab" class="case-tab-content active">
                <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.75rem; font-size: 1rem; color: var(--text); font-weight: 600;">Initial Report</h4>
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border); line-height: 1.7; color: var(--text); white-space: pre-wrap;">${escapeHtml(caseItem.message || 'No initial report provided.')}</div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                            <div><strong>Case ID:</strong> <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: 'Courier New', monospace;">${escapeHtml(caseItem.id)}</code></div>
                        <div><strong>Created:</strong> ${createdAt}</div>
                    </div>
                </div>
                ${filesHtml}
                </div>

                <!-- Tab Content: Updates & Timeline -->
                <div id="caseTimelineTab" class="case-tab-content" style="display: none;">
                ${updatesHtml}
                    ${(() => {
                        const clientReplies = caseItem.clientReplies || [];
                        const lastViewKey = `lastView_${caseItem.id}`;
                        const lastViewTime = localStorage.getItem(lastViewKey) ? new Date(localStorage.getItem(lastViewKey)) : null;
                        const newMessages = lastViewTime 
                            ? clientReplies.filter(reply => new Date(reply.date) > lastViewTime)
                            : clientReplies;
                        const newCount = newMessages.length;
                        
                        if (clientReplies.length === 0) return '';
                        
                        return `
                        <div style="background: #faf5ff; padding: 1.25rem; border-radius: 0.75rem; margin-top: 1rem; border-left: 4px solid #a855f7; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #7c3aed; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                                    <span>Client Messages</span>
                                    ${newCount > 0 ? `<span style="background: #dc2626; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; animation: pulse 2s ease-in-out infinite;">${newCount} New</span>` : ''}
                                </h4>
                                <p style="margin: 0; font-size: 0.875rem; color: #64748b;">
                                    ${clientReplies.length} total message${clientReplies.length !== 1 ? 's' : ''}
                                    ${newCount > 0 ? ` • ${newCount} unread` : ' • All read'}
                                </p>
                            </div>
                            <button class="btn btn-primary reply-to-message-btn" 
                                    data-client-email="${escapeHtml(caseItem.email || '')}" 
                                    data-case-id="${escapeHtml(caseItem.id)}"
                                    data-client-name="${escapeHtml(caseItem.name || 'Client')}"
                                    style="padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer;">
                                Open Chat
                            </button>
                        </div>
                        `;
                    })()}
                    ${caseItem.emailHistory && caseItem.emailHistory.length > 0 ? `
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; border-left: 4px solid #10b981;">
                            <h4 style="margin-bottom: 0.75rem; color: #059669; display: flex; align-items: center; gap: 0.5rem;">
                                <span>Email History (${caseItem.emailHistory.length})</span>
                            </h4>
                            ${caseItem.emailHistory.map((email, index) => {
                                const emailDate = new Date(email.date);
                                const priorityColors = {
                                    'urgent': '#dc2626',
                                    'high': '#ea580c',
                                    'normal': '#7c3aed'
                                };
                                const priorityColor = priorityColors[email.priority] || '#7c3aed';
                                return `
                                    <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 3px solid ${priorityColor};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                                    <span data-icon="email" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle;"></span>
                                                    <span>${escapeHtml(email.subject)}</span>
                                                    ${email.priority && email.priority !== 'normal' ? `
                                                        <span style="background: ${priorityColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600;">
                                                            ${email.priority.toUpperCase()}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                <div style="font-size: 0.875rem; color: #64748b;">
                                                    <span>To: ${escapeHtml(email.to)}</span>
                                                    ${email.cc ? ` | CC: ${escapeHtml(email.cc)}` : ''}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 0.75rem; color: #64748b;">
                                                    ${emailDate.toLocaleString('en-US', {
                                                        month: 'short',
                                                        day: 'numeric',
                                                        year: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e2e8f0;">
                                            Sent by: <strong>${escapeHtml(email.sentBy || 'Admin')}</strong> | 
                                            Status: <span style="color: #10b981; font-weight: 600;">${escapeHtml(email.status || 'sent')}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>

                <!-- Tab Content: Email Composer -->
                <div id="caseEmailTab" class="case-tab-content" style="display: none;">
                    <div style="text-align: center; padding: 3rem; background: #f8fafc; border-radius: 0.75rem; border: 2px dashed var(--border);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--text);">Compose Email</h3>
                        <p style="margin: 0 0 1.5rem 0; color: var(--text-light);">Use the email composer to send messages to ${escapeHtml(caseItem.name || 'the client')}</p>
                        <button class="btn btn-primary open-email-composer-btn" 
                                data-client-email="${escapeHtml(caseItem.email || '')}" 
                                data-case-id="${escapeHtml(caseItem.id)}">
                            <span data-icon="email" style="display: inline-block; width: 18px; height: 18px; vertical-align: middle; margin-right: 0.5rem;"></span> Open Email Composer
                        </button>
                    </div>
                </div>
            `;

            currentCase = caseItem;
            document.getElementById('viewModal').classList.add('active');
            
            // Attach tab switching functionality
            setTimeout(() => {
                document.querySelectorAll('.case-tab-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Remove active class from all tabs and buttons
                        document.querySelectorAll('.case-tab-btn').forEach(b => {
                            b.classList.remove('active');
                            b.style.borderBottomColor = 'transparent';
                            b.style.color = 'var(--text-light)';
                            b.style.fontWeight = '500';
                        });
                        document.querySelectorAll('.case-tab-content').forEach(c => c.style.display = 'none');
                        
                        // Add active class to clicked tab
                        this.classList.add('active');
                        this.style.borderBottomColor = 'var(--primary)';
                        this.style.color = 'var(--primary)';
                        this.style.fontWeight = '600';
                        
                        // Show corresponding content
                        const tabName = this.getAttribute('data-tab');
                        const contentId = `case${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`;
                        const content = document.getElementById(contentId);
                        if (content) {
                            content.style.display = 'block';
                        }
                    });
                });
            }, 100);
            
            console.log('View modal opened successfully');
        };

        window.closeViewModal = function() {
            document.getElementById('viewModal').classList.remove('active');
        };

        window.openEditFromView = function() {
            document.getElementById('viewModal').classList.remove('active');
            window.openEditModal(currentCase.id);
        };

        window.openWebmail = function(recipientEmail, caseId) {
            console.log('openWebmail called');
            
            // Clear the form
            const form = document.getElementById('webmailForm');
            if (form) {
                form.reset();
            }
            
            // Pre-fill recipient if provided
            if (recipientEmail) {
                const toField = document.getElementById('webmailTo');
                if (toField) toField.value = recipientEmail;
            }
            
            // Pre-fill case ID if provided
            if (caseId) {
                const caseIdField = document.getElementById('webmailCaseId');
                if (caseIdField) caseIdField.value = caseId;
            }
            
            // Show the modal
            const modal = document.getElementById('webmailModal');
            if (modal) {
                modal.classList.add('active');
                // Webmail modal opened
            }
        };

        window.closeWebmail = function() {
            document.getElementById('webmailModal').classList.remove('active');
            document.getElementById('webmailStatus').innerHTML = '';
        };

        window.applyTemplate = function() {
            const template = document.getElementById('emailTemplate').value;
            const messageField = document.getElementById('webmailMessage');
            const subjectField = document.getElementById('webmailSubject');
            
            const templates = {
                'welcome': {
                    subject: 'Welcome to Sleuthservice',
                    message: 'Dear Valued Client,\n\nThank you for choosing Sleuthservice! We are excited to work with you.\n\nOur team is committed to providing you with exceptional service and will keep you updated on every step of the process.\n\nIf you have any questions or need assistance, please don\'t hesitate to reach out to us.\n\nBest regards,\nSleuthservice'
                },
                'update': {
                    subject: 'Case Update - Sleuthservice',
                    message: 'Dear Client,\n\nWe wanted to update you on the status of your case.\n\nOur team is actively working on your matter and we expect to provide you with more information soon.\n\nWe appreciate your patience and will continue to keep you informed of any significant developments.\n\nBest regards,\nSleuthservice'
                },
                'completion': {
                    subject: 'Case Completed - Sleuthservice',
                    message: 'Dear Client,\n\nWe are pleased to inform you that your case has been completed.\n\nAll documentation and final reports have been prepared and are ready for review. Our team will contact you shortly to discuss the findings.\n\nThank you for trusting Sleuthservice with your important matters.\n\nBest regards,\nSleuthservice'
                },
                'info': {
                    subject: 'Information Request - Sleuthservice',
                    message: 'Dear Client,\n\nWe require some additional information to proceed with your case.\n\nCould you please provide the following details:\n\n- [Specify information needed]\n\nPlease send this information at your earliest convenience so we can continue to provide you with the best possible service.\n\nBest regards,\nSleuthservice'
                }
            };
            
            if (template && templates[template]) {
                messageField.value = templates[template].message;
                subjectField.value = templates[template].subject;
            }
        };

        window.previewEmail = function() {
            console.log('Preview email function called');
            const to = document.getElementById('webmailTo').value || 'example@email.com';
            const subject = document.getElementById('webmailSubject').value || 'Email Preview';
            const message = document.getElementById('webmailMessage').value || '';
            const caseId = document.getElementById('webmailCaseId').value || 'C-EXAMPLE123';
            const priority = document.getElementById('emailPriority').value;
            
            // Mark webmail modal as having preview on top
            const webmailModal = document.getElementById('webmailModal');
            if (webmailModal) {
                webmailModal.classList.add('has-preview');
            }
            
            console.log('Preview data:', { to, subject, message, caseId, priority });
            
            // Build preview HTML
            const priorityColors = {
                'urgent': '#dc2626',
                'high': '#ea580c',
                'normal': '#7c3aed'
            };
            const priorityColor = priorityColors[priority] || '#7c3aed';
            
            // Build meta info display
            const priorityBadge = priority && priority !== 'normal' 
                ? `<span style="background: ${priorityColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">${priority.toUpperCase()}</span>`
                : '';
            
            const metaHtml = `
                <div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">TO</div>
                    <div style="font-weight: 600; color: var(--text);">${to}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">SUBJECT</div>
                    <div style="font-weight: 600; color: var(--text);">${subject}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">PRIORITY</div>
                    <div>${priorityBadge || '<span style="color: var(--text-light);">Normal</span>'}</div>
                </div>
            `;
            
            // Build email HTML content
            const previewHtml = `
                <div style="min-width: 600px;">
                    <div style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); padding: 30px; text-align: center;">
                        <h1 style="color: white; margin: 0; font-size: 2rem; font-weight: 700;" data-company-name>Sleuthservice</h1>
                    </div>
                    ${priority && priority !== 'normal' ? `
                    <div style="background: ${priorityColor}; color: white; padding: 15px 30px; text-align: center; font-weight: 600; font-size: 0.875rem; letter-spacing: 0.05em;">
                        <span data-icon="lightning" style="display: inline-block; width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></span> ${priority.toUpperCase()} PRIORITY
                    </div>
                    ` : ''}
                    <div style="background: #f8fafc; padding: 40px 30px;">
                        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); line-height: 1.6; color: #1e293b;">
                            ${message ? message.replace(/\n/g, '<br>').replace(/  /g, '&nbsp;&nbsp;') : '<em style="color: #94a3b8;">Your message will appear here...</em>'}
                        </div>
                        ${caseId && caseId !== 'C-EXAMPLE123' ? `
                            <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #faf5ff 0%, #ede9fe 100%); border-radius: 12px; border-left: 4px solid #7c3aed;">
                                <div style="font-size: 0.875rem; color: #7c3aed; font-weight: 600; margin-bottom: 0.75rem;"><span data-icon="document" style="display: inline-block; width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></span> CASE REFERENCE</div>
                                <div style="font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: 600; color: #7c3aed; margin-bottom: 1rem;">
                                    ${caseId}
                                </div>
                                <a href="#" style="display: inline-block; padding: 12px 24px; background: #7c3aed; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 4px rgba(124,58,237,0.2);">
                                    <span data-icon="document" style="display: inline-block; width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></span> View Case Details
                                </a>
                            </div>
                        ` : ''}
                    </div>
                    <div style="background: #f1f5f9; padding: 25px; text-align: center; border-top: 1px solid #e2e8f0;">
                        <p style="color: #64748b; margin: 0; font-size: 0.875rem;">
                            This email was sent from Sleuthservice &copy; ${new Date().getFullYear()}
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('emailPreviewMeta').innerHTML = metaHtml;
            document.getElementById('emailPreviewContent').innerHTML = previewHtml;
            document.getElementById('emailPreviewModal').classList.add('active');
            console.log('Preview modal should be visible now');
        };

        window.closePreview = function() {
            console.log('closePreview function called');
            
            // Close preview modal
            const previewModal = document.getElementById('emailPreviewModal');
            if (previewModal) {
                console.log('Removing active class from preview modal');
                previewModal.classList.remove('active');
            }
            
            // Make sure webmail modal is visible
            const webmailModal = document.getElementById('webmailModal');
            if (webmailModal) {
                webmailModal.classList.remove('has-preview');
                if (!webmailModal.classList.contains('active')) {
                    console.log('Adding active class to webmail modal');
                    webmailModal.classList.add('active');
                }
            }
        };

        // Define handleLogin function before DOMContentLoaded
        async function handleLogin(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (window.adminLoginSubmitting || document.getElementById('loginForm')?.getAttribute('aria-busy') === 'true') { return; }
            window.adminLoginSubmitting = true;
            const loginFormEl = document.getElementById('loginForm');
            if (loginFormEl) { loginFormEl.setAttribute('aria-busy','true'); }
            console.log('handleLogin called');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const submitBtn = document.getElementById('loginSubmitBtn');
            const btnText = document.getElementById('loginBtnText');
            const btnSpinner = document.getElementById('loginBtnSpinner');

            console.log('Login attempt:', { email, passwordLength: password.length });

            // Hide error
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            
            // Show loading
            if (submitBtn) {
                submitBtn.disabled = true;
            }
            if (btnText) {
                btnText.style.display = 'none';
            }
            if (btnSpinner) {
                btnSpinner.style.display = 'inline-block';
            }

            try {
                console.log('Sending login request...');
                const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                console.log('Response status:', response.status, response.statusText);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                // Read response text once (can only be read once)
                const responseText = await response.text();
                console.log('Response text:', responseText);

                // Check content type before parsing
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Non-JSON response:', responseText);
                    throw new Error(`Server error: ${response.status} ${response.statusText}. ${responseText.substring(0, 100)}`);
                }

                let data;
                try {
                    if (!responseText || responseText.trim() === '') {
                        throw new Error('Empty server response');
                    }
                    data = JSON.parse(responseText);
                    console.log('Response data:', data);
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    throw new Error(`Invalid server response (${response.status}): ${responseText.substring(0, 200)}`);
                }
                
                if (response.ok && data.success && data.token) {
                    console.log('Login successful!');
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    
                    // Show success
                    if (btnText) {
                        btnText.textContent = '✓ Success!';
                        btnText.style.display = 'inline';
                    }
                    if (btnSpinner) {
                        btnSpinner.style.display = 'none';
                    }
                    
                    // Redirect to dashboard
                    setTimeout(() => {
                        console.log('Showing dashboard...');
                        showDashboard();
                        loadCases();
                    }, 500);
                } else {
                    console.error('Login failed:', data);
                    // Show error
                    let errorMsg = data.error || data.message || 'Invalid email or password. Please try again.';
                    
                    // Handle rate limiting
                    if (response.status === 429) {
                        const retryAfter = data.retryAfter || 900; // Default to 15 minutes
                        const minutes = Math.ceil(retryAfter / 60);
                        errorMsg = `Too many login attempts. Please wait ${minutes} minute${minutes !== 1 ? 's' : ''} before trying again.`;
                    }
                    
                    if (errorDiv) {
                        errorDiv.textContent = errorMsg;
                        errorDiv.style.display = 'block';
                    }
                    
                    // Re-enable button
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                    if (btnText) {
                        btnText.style.display = 'inline';
                        btnText.textContent = 'Sign In';
                    }
                    if (btnSpinner) {
                        btnSpinner.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error
                let errorMsg = 'Connection error. Please check your internet connection and try again.';
                if (error.message) {
                    errorMsg = error.message;
                } else if (error.name === 'TypeError' && error.message && error.message.includes('fetch')) {
                    if (API_BASE_URL.includes('localhost')) {
                        errorMsg = `<span data-icon="close" style="display: inline-block; width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></span> Cannot connect to backend server!\n\nThe backend server must be running to login.\n\nTo start the server:\n1. Open terminal\n2. cd backend\n3. npm start\n\nThen try logging in again.`;
                    } else {
                        errorMsg = `Cannot connect to server at ${API_BASE_URL}. The server may be down or unreachable.`;
                    }
                }
                if (errorDiv) {
                    errorDiv.style.whiteSpace = 'pre-line'; // Allow line breaks
                }
                if (errorDiv) {
                    errorDiv.textContent = errorMsg;
                    errorDiv.style.display = 'block';
                }
                
                // Re-enable button
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
                if (btnText) {
                    btnText.style.display = 'inline';
                    btnText.textContent = 'Sign In';
                }
                if (btnSpinner) {
                    btnSpinner.style.display = 'none';
                }
                const formRef = document.getElementById('loginForm');
                if (formRef) { formRef.removeAttribute('aria-busy'); }
                window.adminLoginSubmitting = false;
            }
        }

        // Make handleLogin globally accessible
        window.handleLogin = handleLogin;
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded - Initializing admin dashboard');
            
            // Get references
            const loginScreen = document.getElementById('loginScreen');
            const adminDashboard = document.getElementById('adminDashboard');
            const loginForm = document.getElementById('loginForm');
            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            
            // Ensure initial state: Show login, hide dashboard
            if (loginScreen) {
                loginScreen.style.display = 'flex';
                loginScreen.classList.remove('hidden');
            }
            if (adminDashboard) {
                adminDashboard.style.display = 'none';
                adminDashboard.classList.add('hidden');
            }
            
            // Attach login handlers FIRST (before checking token)
            if (loginForm) {
                console.log('Attaching login form submit handler');
                loginForm.addEventListener('submit', function(e) {
                    console.log('Form submit event triggered');
                    e.preventDefault();
                    e.stopPropagation();
                    handleLogin(e);
                }, false);
            } else {
                console.error('Login form element not found!');
            }
            
            if (loginSubmitBtn) {
                console.log('Attaching login button click handler');
                loginSubmitBtn.addEventListener('click', function(e) {
                    console.log('Login button clicked directly');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const email = document.getElementById('loginEmail')?.value;
                    const password = document.getElementById('loginPassword')?.value;
                    
                    if (email && password) {
                        handleLogin(e);
                    } else {
                        console.warn('Email or password missing');
                        if (loginForm) {
                            loginForm.reportValidity();
                        }
                    }
                }, false);
            }
            
            // NOW check if already logged in
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                console.log('Token found in storage, validating...');
                authToken = savedToken;
                
                // Verify token is still valid (async)
                (async function() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/admin/cases`, {
                            method: 'GET',
                            headers: { 
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log('Token validation response:', response.status);
                        
                        if (response.ok) {
                            console.log('Token valid, showing dashboard');
                            showDashboard();
                            // Wait a bit for DOM to settle
                            setTimeout(() => {
                                loadCases();
                            }, 100);
                        } else {
                            console.log('Token invalid, showing login');
                            localStorage.removeItem('adminToken');
                            authToken = null;
                            showLogin();
                        }
                    } catch (error) {
                        console.error('Token validation error:', error);
                        localStorage.removeItem('adminToken');
                        authToken = null;
                        showLogin();
                    }
                })();
            } else {
                console.log('No token found, showing login screen');
                showLogin();
            }
            
            // Initialize dashboard components (for when dashboard is shown)
            function initDashboardComponents() {
                // Messages search and filter
                const messagesSearch = document.getElementById('messagesSearch');
                if (messagesSearch) {
                    messagesSearch.addEventListener('input', () => renderMessages());
                }
                
                const messagesFilter = document.getElementById('messagesFilter');
                if (messagesFilter) {
                    messagesFilter.addEventListener('change', () => renderMessages());
                }
                
                // Navigation buttons
                const messagesNavBtn = document.getElementById('messagesNavBtn');
                if (messagesNavBtn) {
                    messagesNavBtn.addEventListener('click', window.showMessagesView);
                }
                
                const casesNavBtn = document.getElementById('casesNavBtn');
                if (casesNavBtn) {
                    casesNavBtn.addEventListener('click', window.showCasesView);
                }
            }
            
            // Initialize dashboard components
            initDashboardComponents();
            
            // Initialize icons after DOM is ready
            function initializeIconsNow() {
                if (window.initAllIcons) {
                    window.initAllIcons();
                    console.log('[Admin Dashboard] Icons initialized');
                } else {
                    // Retry if icons.js hasn't loaded yet
                    setTimeout(initializeIconsNow, 100);
                }
            }
            
            // Try multiple times to ensure icons load
            setTimeout(initializeIconsNow, 100);
            setTimeout(initializeIconsNow, 500);
            setTimeout(initializeIconsNow, 1000);
            
            // Other event listeners for modals, etc.
            const previewModal = document.getElementById('emailPreviewModal');
            if (previewModal) {
                previewModal.addEventListener('click', (e) => {
                    if (e.target === previewModal) {
                        window.closePreview();
                    }
                });
            }
            
            // Filter buttons
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', window.applyFilters);
            }
            
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', window.clearFilters);
            }
            
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            if (exportCSVBtn) {
                exportCSVBtn.addEventListener('click', window.exportCSV);
            }
            
            // Pagination buttons
            const prevPageBtn = document.getElementById('prevPageBtn');
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => window.changePage(-1));
            }
            
            const nextPageBtn = document.getElementById('nextPageBtn');
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => window.changePage(1));
            }

            // Edit form handler
            const editForm = document.getElementById('editCaseForm');
            if (editForm) {
                editForm.addEventListener('submit', handleEdit);
            }

            // Webmail form handler - attach once globally
            const webmailForm = document.getElementById('webmailForm');
            if (webmailForm) {
                console.log('Attaching webmail form handler');
                webmailForm.addEventListener('submit', function(e) {
                    console.log('Webmail form submit event triggered');
                    e.preventDefault();
                    handleWebmail(e);
                }, false);
            } else {
                console.log('Webmail form not found during initialization');
            }
            
            // Email template selector
            const emailTemplate = document.getElementById('emailTemplate');
            if (emailTemplate) {
                emailTemplate.addEventListener('change', function(e) {
                    e.preventDefault();
                    if (typeof window.applyTemplate === 'function') {
                        window.applyTemplate();
                    }
                });
            }

            // Preview email button
            const previewEmailBtn = document.getElementById('previewEmailBtn');
            if (previewEmailBtn) {
                previewEmailBtn.addEventListener('click', () => {
                    console.log('Preview button clicked');
                    window.previewEmail();
                });
            }


            // Close modal on outside click for edit modal
            const editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('click', (e) => {
                    if (e.target === editModal) {
                        window.closeModal();
                    }
                });
            }

            // Close modal on outside click for view modal
            const viewModal = document.getElementById('viewModal');
            if (viewModal) {
                viewModal.addEventListener('click', (e) => {
                    if (e.target === viewModal) {
                        window.closeViewModal();
                    }
                });
            }

            // Add event listeners for close/cancel buttons
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    window.closeModal();
                });
            }

            const closeEditModalBtn = document.getElementById('closeEditModalBtn');
            if (closeEditModalBtn) {
                closeEditModalBtn.addEventListener('click', () => {
                    window.closeModal();
                });
            }

            const closeViewModalBtn = document.getElementById('closeViewModalBtn');
            if (closeViewModalBtn) {
                closeViewModalBtn.addEventListener('click', () => {
                    window.closeViewModal();
                });
            }

            const closeViewBtn = document.getElementById('closeViewBtn');
            if (closeViewBtn) {
                closeViewBtn.addEventListener('click', () => {
                    window.closeViewModal();
                });
            }

            const editFromViewBtn = document.getElementById('editFromViewBtn');
            if (editFromViewBtn) {
                editFromViewBtn.addEventListener('click', () => {
                    window.openEditFromView();
                });
            }

            const sendEmailFromViewBtn = document.getElementById('sendEmailFromViewBtn');
            if (sendEmailFromViewBtn) {
                sendEmailFromViewBtn.addEventListener('click', () => {
                    if (currentCase) {
                        document.getElementById('viewModal').classList.remove('active');
                        window.openWebmail(currentCase.email, currentCase.id);
                    }
                });
            }

            // Webmail modal handlers
            const closeWebmailBtn = document.getElementById('closeWebmailBtn');
            if (closeWebmailBtn) {
                closeWebmailBtn.addEventListener('click', () => {
                    window.closeWebmail();
                });
            }

            const cancelWebmailBtn = document.getElementById('cancelWebmailBtn');
            if (cancelWebmailBtn) {
                cancelWebmailBtn.addEventListener('click', () => {
                    window.closeWebmail();
                });
            }

            // Close webmail modal on outside click
            const webmailModal = document.getElementById('webmailModal');
            if (webmailModal) {
                webmailModal.addEventListener('click', (e) => {
                    if (e.target === webmailModal) {
                        window.closeWebmail();
                    }
                });
            }
            
            // Reply to client message buttons (delegated event listener for dynamically added buttons)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('reply-to-message-btn') || e.target.closest('.reply-to-message-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Reply button clicked');
                    const btn = e.target.classList.contains('reply-to-message-btn') ? e.target : e.target.closest('.reply-to-message-btn');
                    const email = btn.getAttribute('data-client-email');
                    const caseId = btn.getAttribute('data-case-id');
                    const clientName = btn.getAttribute('data-client-name');
                    
                    console.log('Opening chat:', { caseId, clientName, email });
                    // Open chat modal - use window function
                    if (typeof window.openAdminChatModal === 'function') {
                        window.openAdminChatModal(caseId, clientName, email);
                    } else {
                        console.error('openAdminChatModal function not found');
                        alert('Chat function not available. Please refresh the page.');
                    }
                }
                
                // Open email composer button (delegated event listener)
                if (e.target.classList.contains('open-email-composer-btn') || e.target.closest('.open-email-composer-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const btn = e.target.classList.contains('open-email-composer-btn') ? e.target : e.target.closest('.open-email-composer-btn');
                    const email = btn.getAttribute('data-client-email');
                    const caseId = btn.getAttribute('data-case-id');
                    
                    // Close view modal and open webmail
                    const viewModal = document.getElementById('viewModal');
                    if (viewModal) {
                        viewModal.classList.remove('active');
                    }
                    if (typeof window.openWebmail === 'function') {
                        window.openWebmail(email, caseId);
                    } else {
                        console.error('openWebmail not available');
                    }
                }
            });
            
            // Admin chat form submission
            const adminChatForm = document.getElementById('adminChatForm');
            if (adminChatForm) {
                adminChatForm.addEventListener('submit', handleAdminReply);
            }
            
            // Admin chat message character counter
            const adminChatMessage = document.getElementById('adminChatMessage');
            const adminChatCharCount = document.getElementById('adminChatCharCount');
            if (adminChatMessage && adminChatCharCount) {
                adminChatMessage.addEventListener('input', () => {
                    const length = adminChatMessage.value.length;
                    adminChatCharCount.textContent = `${length} / 1000`;
                    if (length > 1000) {
                        adminChatCharCount.style.color = '#dc2626';
                    } else {
                        adminChatCharCount.style.color = 'var(--text-light)';
                    }
                });
            }
            
            // Close admin chat modal
            const closeAdminChatBtn = document.getElementById('closeAdminChatBtn');
            if (closeAdminChatBtn) {
                closeAdminChatBtn.addEventListener('click', () => {
                    window.closeAdminChatModal();
                });
            }
            
            // Close modal when clicking outside
            const adminChatModal = document.getElementById('adminChatModal');
            if (adminChatModal) {
                adminChatModal.addEventListener('click', (e) => {
                    if (e.target === adminChatModal) {
                        window.closeAdminChatModal();
                    }
                });
            }

            // Add event listener for logout button
            const logoutBtn = document.getElementById('logoutBtn');
            console.log('Logout button found:', logoutBtn);
            if (logoutBtn) {
                console.log('Logout button text:', logoutBtn.textContent.trim());
                logoutBtn.addEventListener('click', (e) => {
                    console.log('Logout button clicked');
                    e.preventDefault();
                    window.logout();
                });
            }
            
            // Add event listener for close preview button
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            if (closePreviewBtn) {
                console.log('Close preview button found');
                closePreviewBtn.addEventListener('click', (e) => {
                    console.log('Close preview button clicked');
                    e.preventDefault();
                    window.closePreview();
                });
            }
            
            // Add event listener for back to editor button
            const backToEditorBtn = document.getElementById('backToEditorBtn');
            if (backToEditorBtn) {
                console.log('Back to editor button found');
                backToEditorBtn.addEventListener('click', (e) => {
                    console.log('Back to editor button clicked');
                    e.preventDefault();
                    window.closePreview();
                });
            }
        });

        window.showMessagesView = function() {
            console.log('showMessagesView called');
            const casesView = document.getElementById('casesView');
            const messagesView = document.getElementById('messagesView');
            const messagesBtn = document.getElementById('messagesNavBtn');
            const casesBtn = document.getElementById('casesNavBtn');
            
            if (!casesView || !messagesView) {
                console.error('Views not found:', { casesView, messagesView });
                return;
            }
            
            console.log('Hiding cases view, showing messages view');
            casesView.classList.add('hidden');
            casesView.style.display = 'none';
            messagesView.classList.remove('hidden');
            messagesView.style.display = 'block'; // Force display
            
            // Verify the view is actually visible
            setTimeout(() => {
                const messagesViewStyle = window.getComputedStyle(messagesView);
                console.log('Messages view computed style:', {
                    display: messagesViewStyle.display,
                    visibility: messagesViewStyle.visibility,
                    hasHidden: messagesView.classList.contains('hidden'),
                    opacity: messagesViewStyle.opacity,
                    height: messagesViewStyle.height
                });
                
                const container = document.getElementById('messagesContainer');
                if (container) {
                    console.log('Messages container:', {
                        hasContent: container.innerHTML.length > 0,
                        children: container.children.length,
                        innerHTMLLength: container.innerHTML.length
                    });
                }
            }, 100);
            
            // Update nav buttons
            if (messagesBtn) messagesBtn.classList.add('active');
            if (casesBtn) casesBtn.classList.remove('active');
            
            // Load messages
            console.log('Loading all messages...');
            if (typeof loadAllMessages === 'function') {
                loadAllMessages().catch(error => {
                    console.error('Error loading messages:', error);
                });
            } else {
                console.error('loadAllMessages function not found');
            }
        };
        
        window.showCasesView = function() {
            console.log('showCasesView called');
            const casesView = document.getElementById('casesView');
            const messagesView = document.getElementById('messagesView');
            const messagesBtn = document.getElementById('messagesNavBtn');
            const casesBtn = document.getElementById('casesNavBtn');
            
            if (!casesView || !messagesView) {
                console.error('Views not found:', { casesView, messagesView });
                return;
            }
            
            messagesView.classList.add('hidden');
            messagesView.style.display = 'none';
            casesView.classList.remove('hidden');
            casesView.style.display = 'block';
            
            // Update nav buttons
            if (casesBtn) casesBtn.classList.add('active');
            if (messagesBtn) messagesBtn.classList.remove('active');
        };
        
        async function loadAllMessages() {
            console.log('loadAllMessages called');
            try {
                // Get all cases to extract messages
                console.log('Fetching cases from API...');
                const response = await fetch(`${API_BASE_URL}/api/admin/cases?limit=10000`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data received:', data);
                
                if (!data.success) {
                    throw new Error('Failed to load cases');
                }
                
                // Extract all client messages with case context
                allMessages = [];
                const cases = data.cases || [];
                console.log('Total cases found:', cases.length);
                
                cases.forEach(caseItem => {
                    if (caseItem.clientReplies && caseItem.clientReplies.length > 0) {
                        console.log(`Case ${caseItem.id} has ${caseItem.clientReplies.length} client replies`);
                        caseItem.clientReplies.forEach(reply => {
                            allMessages.push({
                                ...reply,
                                caseId: caseItem.id,
                                caseService: caseItem.service,
                                clientName: caseItem.name,
                                clientEmail: caseItem.email,
                                caseStatus: caseItem.status
                            });
                        });
                    }
                });
                
                console.log('Total messages extracted:', allMessages.length);
                
                // Sort by date (newest first)
                allMessages.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log('Rendering messages...');
                renderMessages();
                console.log('renderMessages completed');
            } catch (error) {
                console.error('Load messages error:', error);
                document.getElementById('messagesContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 0.75rem; box-shadow: var(--shadow);">
                        <p style="color: #dc2626;">Failed to load messages: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderMessages() {
            console.log('renderMessages function called');
            const container = document.getElementById('messagesContainer');
            if (!container) {
                console.error('messagesContainer element not found!');
                return;
            }
            
            const searchInput = document.getElementById('messagesSearch');
            const filterSelect = document.getElementById('messagesFilter');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const filterValue = filterSelect ? filterSelect.value : 'all';
            
            console.log('Rendering with', allMessages.length, 'messages, search:', searchTerm, 'filter:', filterValue);
            
            // Filter messages
            let filteredMessages = [...allMessages];
            
            // Search filter
            if (searchTerm) {
                filteredMessages = filteredMessages.filter(msg => 
                    msg.message.toLowerCase().includes(searchTerm) ||
                    msg.clientName?.toLowerCase().includes(searchTerm) ||
                    msg.clientEmail?.toLowerCase().includes(searchTerm) ||
                    msg.caseId?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Date filter
            if (filterValue !== 'all') {
                const now = new Date();
                filteredMessages = filteredMessages.filter(msg => {
                    const msgDate = new Date(msg.date);
                    switch(filterValue) {
                        case 'today':
                            return msgDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return msgDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            return msgDate >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            if (filteredMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 0.75rem; box-shadow: var(--shadow);">
                        <h3 style="color: var(--text-light); margin-bottom: 0.5rem;">No messages found</h3>
                        <p style="color: var(--text-light);">${searchTerm || filterValue !== 'all' ? 'Try adjusting your filters.' : 'No client messages yet.'}</p>
                    </div>
                `;
                return;
            }
            
            // Group messages by case to show counts instead of individual messages
            const messagesByCase = {};
            filteredMessages.forEach(msg => {
                if (!messagesByCase[msg.caseId]) {
                    messagesByCase[msg.caseId] = {
                        caseId: msg.caseId,
                        caseService: msg.caseService,
                        caseStatus: msg.caseStatus,
                        clientName: msg.clientName,
                        clientEmail: msg.clientEmail,
                        messages: [],
                        newCount: 0
                    };
                }
                messagesByCase[msg.caseId].messages.push(msg);
                // Check if message is new (after last view)
                const lastViewKey = `lastView_${msg.caseId}`;
                const lastViewTime = localStorage.getItem(lastViewKey) ? new Date(localStorage.getItem(lastViewKey)) : null;
                if (!lastViewTime || new Date(msg.date) > lastViewTime) {
                    messagesByCase[msg.caseId].newCount++;
                }
            });
            
            console.log('Grouped messages into', Object.keys(messagesByCase).length, 'cases');
            
            try {
            const html = Object.values(messagesByCase).map(caseGroup => {
                const latestMsg = caseGroup.messages[0]; // Already sorted by date (newest first)
                const msgDate = new Date(latestMsg.date);
                const timeAgo = getTimeAgo(msgDate);
                
                return `
                    <div class="message-card" 
                         data-case-id="${escapeHtml(caseGroup.caseId)}"
                         data-client-name="${escapeHtml(caseGroup.clientName || 'Client')}"
                         data-client-email="${escapeHtml(caseGroup.clientEmail || '')}"
                         style="background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow); border-left: 4px solid ${caseGroup.newCount > 0 ? '#dc2626' : '#a855f7'}; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;" 
                         onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                         onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='var(--shadow)'}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <div style="font-weight: 700; font-size: 1.125rem; color: var(--text);">${escapeHtml(caseGroup.clientName || caseGroup.clientEmail || 'Client')}</div>
                                    <span class="status-badge status-${caseGroup.caseStatus}" style="font-size: 0.75rem;">${caseGroup.caseStatus}</span>
                                    ${caseGroup.newCount > 0 ? `<span style="background: #dc2626; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; animation: pulse 2s ease-in-out infinite;">${caseGroup.newCount} New</span>` : ''}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.75rem;">
                                    <strong>Case:</strong> <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${escapeHtml(caseGroup.caseId)}</code>
                                    ${caseGroup.caseService ? ` | <strong>Service:</strong> ${escapeHtml(caseGroup.caseService)}` : ''}
                                </div>
                                <div style="background: #faf5ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 3px solid #a855f7;">
                                    <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                        <span><strong>${caseGroup.messages.length} message${caseGroup.messages.length !== 1 ? 's' : ''}</strong>${caseGroup.newCount > 0 ? ` • <span style="color: #dc2626; font-weight: 700;">${caseGroup.newCount} new</span>` : ''}</span>
                                        <span>Last: ${timeAgo}</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text); line-height: 1.5; white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                        ${escapeHtml(latestMsg.message.substring(0, 150))}${latestMsg.message.length > 150 ? '...' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button class="btn btn-primary btn-sm open-chat-btn" 
                                    data-case-id="${escapeHtml(caseGroup.caseId)}"
                                    data-client-name="${escapeHtml(caseGroup.clientName || 'Client')}"
                                    data-client-email="${escapeHtml(caseGroup.clientEmail || '')}"
                                    style="font-size: 0.875rem; cursor: pointer;">
                                💬 Open Chat
                            </button>
                            <button class="btn btn-secondary btn-sm view-case-from-message-btn" 
                                    data-case-id="${escapeHtml(caseGroup.caseId)}"
                                    style="font-size: 0.875rem;">
                                👁️ View Case
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Initialize icons after messages are rendered
            if (window.initAllIcons) {
                setTimeout(() => window.initAllIcons(), 100);
            }
            
            console.log('Messages HTML rendered successfully');
            
            // Attach event listeners for dynamically created buttons
            container.querySelectorAll('.view-case-from-message-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const caseId = this.getAttribute('data-case-id');
                    window.showCasesView();
                    setTimeout(() => {
                        window.viewCaseDetails(caseId);
                    }, 100);
                });
            });

            // Delegated handlers for opening chat
            container.querySelectorAll('.open-chat-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const caseId = btn.getAttribute('data-case-id');
                    const name = btn.getAttribute('data-client-name');
                    const email = btn.getAttribute('data-client-email');
                    console.log('Open Chat (button) ->', { caseId, name, email });
                    if (window.openAdminChatModal) {
                        window.openAdminChatModal(caseId, name, email);
                    }
                });
            });

            container.querySelectorAll('.message-card').forEach(card => {
                card.addEventListener('click', () => {
                    const caseId = card.getAttribute('data-case-id');
                    const name = card.getAttribute('data-client-name');
                    const email = card.getAttribute('data-client-email');
                    console.log('Open Chat (card) ->', { caseId, name, email });
                    if (window.openAdminChatModal) {
                        window.openAdminChatModal(caseId, name, email);
                    }
                });
            });
            } catch (error) {
                console.error('Error rendering messages:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 0.75rem; box-shadow: var(--shadow);">
                        <p style="color: #dc2626;">Error rendering messages: ${escapeHtml(error.message)}</p>
                    </div>
                `;
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }


        async function loadCases() {
            try {
                // Build query string from filters
                const params = new URLSearchParams();
                if (currentFilters.search) params.append('search', currentFilters.search);
                if (currentFilters.status) params.append('status', currentFilters.status);
                if (currentFilters.startDate) params.append('startDate', currentFilters.startDate);
                if (currentFilters.endDate) params.append('endDate', currentFilters.endDate);
                params.append('sortBy', currentFilters.sortBy);
                params.append('sortOrder', currentFilters.sortOrder);
                params.append('page', currentFilters.page);
                params.append('limit', currentFilters.limit);
                
                const response = await fetch(`${API_BASE_URL}/api/admin/cases?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    casesData = data.cases || [];
                    paginationData = data.pagination || null;
                    updateStats();
                    renderCases();
                    updatePaginationControls();
                } else if (data.error) {
                    if (data.error.includes('token') || data.error.includes('Unauthorized')) {
                        alert('Session expired. Please login again.');
                        window.logout(); // This will show login screen, staying in admin area
                    }
                }
            } catch (error) {
                console.error('Load cases error:', error);
                alert('Failed to load cases. Please refresh the page.');
            }
        }

        // Make filter functions globally accessible
        window.applyFilters = function() {
            currentFilters.search = document.getElementById('searchInput').value.trim();
            currentFilters.status = document.getElementById('statusFilter').value;
            currentFilters.startDate = document.getElementById('startDateFilter').value;
            currentFilters.endDate = document.getElementById('endDateFilter').value;
            
            const sortValue = document.getElementById('sortSelect').value;
            const [sortBy, sortOrder] = sortValue.split('-');
            currentFilters.sortBy = sortBy;
            currentFilters.sortOrder = sortOrder;
            currentFilters.page = 1; // Reset to first page
            
            loadCases();
        };
        
        window.clearFilters = function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('sortSelect').value = 'createdAt-desc';
            
            currentFilters = {
                search: '',
                status: '',
                startDate: '',
                endDate: '',
                sortBy: 'createdAt',
                sortOrder: 'desc',
                page: 1,
                limit: 20
            };
            
            loadCases();
        };
        
        window.changePage = function(direction) {
            if (!paginationData) return;
            
            const newPage = currentFilters.page + direction;
            if (newPage >= 1 && newPage <= paginationData.totalPages) {
                currentFilters.page = newPage;
                loadCases();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        
        function updatePaginationControls() {
            const controls = document.getElementById('paginationControls');
            if (!paginationData) {
                controls.style.display = 'none';
                return;
            }
            
            controls.style.display = 'flex';
            document.getElementById('paginationInfo').textContent = 
                `Showing ${((paginationData.page - 1) * paginationData.limit) + 1}-${Math.min(paginationData.page * paginationData.limit, paginationData.total)} of ${paginationData.total} cases`;
            
            document.getElementById('pageInfo').textContent = `Page ${paginationData.page} of ${paginationData.totalPages}`;
            document.getElementById('prevPageBtn').disabled = !paginationData.hasPrevPage;
            document.getElementById('nextPageBtn').disabled = !paginationData.hasNextPage;
        }
        
        window.exportCSV = async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/cases/export/csv`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Export failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cases-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showToast('CSV exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export CSV: ' + error.message);
            }
        };
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : '#a855f7'};
                color: white;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        async function updateStats() {
            // Get all cases for accurate stats (not just paginated)
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/cases?limit=10000`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                const allCases = data.success ? data.cases : casesData;
                
                const total = allCases.length;
                const newCases = allCases.filter(c => c.status === 'new').length;
                const inProgress = allCases.filter(c => c.status === 'in-progress').length;
                const completed = allCases.filter(c => c.status === 'completed').length;

                document.getElementById('totalCases').textContent = total;
                document.getElementById('newCases').textContent = newCases;
                document.getElementById('inProgressCases').textContent = inProgress;
                document.getElementById('completedCases').textContent = completed;
            } catch (error) {
                // Fallback to paginated data
            const total = casesData.length;
            const newCases = casesData.filter(c => c.status === 'new').length;
            const inProgress = casesData.filter(c => c.status === 'in-progress').length;
            const completed = casesData.filter(c => c.status === 'completed').length;

            document.getElementById('totalCases').textContent = total;
            document.getElementById('newCases').textContent = newCases;
            document.getElementById('inProgressCases').textContent = inProgress;
            document.getElementById('completedCases').textContent = completed;
            }
        }

        function renderCases() {
            const tbody = document.getElementById('casesTable');
            
            if (casesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No cases found</td></tr>';
                return;
            }

            tbody.innerHTML = casesData.map(caseItem => {
                const createdAt = new Date(caseItem.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const updatedAt = new Date(caseItem.updatedAt || caseItem.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                return `
                <tr>
                    <td><strong style="font-family: monospace;">${escapeHtml(caseItem.id)}</strong></td>
                    <td>${escapeHtml(caseItem.name || 'N/A')}</td>
                    <td><a href="mailto:${escapeHtml(caseItem.email || '')}">${escapeHtml(caseItem.email || 'N/A')}</a></td>
                    <td>${escapeHtml(caseItem.service || 'N/A')}</td>
                    <td>
                        <select class="quick-status-change" data-case-id="${escapeHtml(caseItem.id)}" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid var(--border); font-size: 0.875rem;">
                            <option value="new" ${caseItem.status === 'new' ? 'selected' : ''}>New</option>
                            <option value="in-progress" ${caseItem.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${caseItem.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="on-hold" ${caseItem.status === 'on-hold' ? 'selected' : ''}>On Hold</option>
                        </select>
                    </td>
                    <td>${createdAt}</td>
                    <td style="font-size: 0.875rem; color: var(--text-light);">${updatedAt}</td>
                    <td style="text-align: center;">
                        ${(() => {
                            const clientReplies = caseItem.clientReplies || [];
                            if (clientReplies.length === 0) return '<span style="color: var(--text-light); font-size: 0.75rem;">—</span>';
                            
                            const lastViewKey = `lastView_${caseItem.id}`;
                            const lastViewTime = localStorage.getItem(lastViewKey) ? new Date(localStorage.getItem(lastViewKey)) : null;
                            const newMessages = lastViewTime 
                                ? clientReplies.filter(reply => new Date(reply.date) > lastViewTime)
                                : clientReplies;
                            const newCount = newMessages.length;
                            
                            return newCount > 0
                                ? `<span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #dc2626; color: white; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; animation: pulse 2s ease-in-out infinite;" title="${newCount} new message${newCount !== 1 ? 's' : ''}">
                                    💬 ${newCount}
                                </span>`
                                : `<span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;" title="${clientReplies.length} message${clientReplies.length !== 1 ? 's' : ''}">
                                    💬 ${clientReplies.length}
                                </span>`;
                        })()}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-case-btn" data-case-id="${escapeHtml(caseItem.id)}">Edit</button>
                        <button class="btn btn-secondary btn-sm view-case-btn" style="margin-left: 0.5rem;" data-case-id="${escapeHtml(caseItem.id)}">View</button>
                    </td>
                </tr>
            `;
            }).join('');

            // Attach event listeners
            tbody.querySelectorAll('.edit-case-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const caseId = e.target.getAttribute('data-case-id');
                    window.openEditModal(caseId);
                });
            });

            tbody.querySelectorAll('.view-case-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const caseId = e.target.getAttribute('data-case-id');
                    window.viewCaseDetails(caseId);
                });
            });
            
            // Quick status change
            // Initialize icons after cases are rendered
            if (window.initAllIcons) {
                setTimeout(() => window.initAllIcons(), 100);
            }
            
            tbody.querySelectorAll('.quick-status-change').forEach(select => {
                select.addEventListener('change', async function(e) {
                    const caseId = this.getAttribute('data-case-id');
                    const originalStatus = this.getAttribute('data-original-status') || this.options[this.selectedIndex].text;
                    const newStatus = this.value;
                    
                    if (confirm(`Change case ${caseId} status to ${newStatus}?`)) {
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/admin/cases/${caseId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${authToken}`
                                },
                                body: JSON.stringify({ status: newStatus })
                            });
                            
                            const data = await response.json();
                            if (data.success) {
                                showToast(`Status updated to ${newStatus}`, 'success');
                                this.setAttribute('data-original-status', newStatus);
                                loadCases();
                            } else {
                                alert('Failed to update status: ' + (data.error || 'Unknown error'));
                                loadCases(); // Reload to revert
                            }
                        } catch (error) {
                            console.error('Status update error:', error);
                            alert('Failed to update status: ' + error.message);
                            loadCases(); // Reload to revert
                        }
                    } else {
                        // Revert selection on cancel
                        loadCases();
                    }
                });
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        // Admin Chat Modal Functions
        let currentChatCaseId = null;
        
        window.openAdminChatModal = async function(caseId, clientName, clientEmail) {
            console.log('openAdminChatModal called with:', { caseId, clientName, clientEmail });
            
            if (!caseId) {
                console.error('No caseId provided');
                alert('Error: No case ID provided');
                return;
            }
            
            currentChatCaseId = caseId;
            const modal = document.getElementById('adminChatModal');
            const caseIdEl = document.getElementById('adminChatCaseId');
            const messagesEl = document.getElementById('adminChatMessages');
            // Close any other open modals that could overlap
            const otherModals = ['viewModal', 'webmailModal', 'emailPreviewModal', 'editModal'];
            otherModals.forEach(id => {
                const m = document.getElementById(id);
                if (m && m.classList.contains('active')) {
                    m.classList.remove('active');
                    m.style.display = 'none';
                }
            });
            
            // Check if modal exists
            if (!modal) {
                console.error('Admin chat modal element not found in DOM');
                alert('Error: Chat modal not found. Please refresh the page.');
                return;
            }
            
            console.log('Modal found, showing...');
            
            // Mark messages as viewed
            const lastViewKey = `lastView_${caseId}`;
            localStorage.setItem(lastViewKey, new Date().toISOString());
            
            if (caseIdEl) caseIdEl.textContent = `Chat - ${caseId}`;
            
            // Show modal - ensure it overlays everything
            modal.classList.add('active');
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.zIndex = '2147483647';
            
            console.log('Modal display set to flex, active class added');
            
            // Verify modal is visible
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(modal);
                console.log('Modal computed style:', {
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    zIndex: computedStyle.zIndex,
                    opacity: computedStyle.opacity
                });
            }, 100);
            
            // Load messages
            try {
                await loadAdminChatMessages(caseId, clientName);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
            
            // Scroll to bottom
            setTimeout(() => {
                if (messagesEl) {
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
            }, 300);
            
            // Focus textarea
            setTimeout(() => {
                const textarea = document.getElementById('adminChatMessage');
                if (textarea) {
                    textarea.focus();
                    console.log('Textarea focused');
                }
            }, 200);
            
            // Refresh cases list to update badge counts
            if (typeof loadCases === 'function') {
                setTimeout(() => loadCases(), 500);
            }
        }

        window.closeAdminChatModal = function() {
            const modal = document.getElementById('adminChatModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
                if (typeof currentChatCaseId !== 'undefined') {
                    currentChatCaseId = null;
                }
            }
        };
        
        async function loadAdminChatMessages(caseId, clientName) {
            const messagesEl = document.getElementById('adminChatMessages');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/cases/${caseId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (!data.success || !data.case) {
                    throw new Error('Failed to load case');
                }
                
                const caseItem = data.case;
                const allMessages = [];
                
                // Add admin updates (messages, not status changes)
                if (caseItem.updates && caseItem.updates.length > 0) {
                    caseItem.updates.forEach(update => {
                        if (update.message && !update.message.includes('Status changed')) {
                            allMessages.push({
                                ...update,
                                type: 'admin',
                                sender: 'You (Admin)',
                                date: update.date || new Date().toISOString()
                            });
                        }
                    });
                }
                
                // Add client replies
                if (caseItem.clientReplies && caseItem.clientReplies.length > 0) {
                    caseItem.clientReplies.forEach(reply => {
                        allMessages.push({
                            ...reply,
                            type: 'client',
                            sender: clientName || 'Client',
                            date: reply.date || new Date().toISOString()
                        });
                    });
                }
                
                // Sort by date
                allMessages.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Render messages
                if (allMessages.length === 0) {
                    messagesEl.innerHTML = `
                        <div style="text-align: center; padding: 3rem 1rem; color: var(--text-light);">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">💬</div>
                            <p style="margin: 0; font-size: 0.95rem;">No messages yet. Start the conversation below!</p>
                        </div>
                    `;
                } else {
                    messagesEl.innerHTML = allMessages.map((msg, index) => {
                        const msgDate = new Date(msg.date);
                        const isAdmin = msg.type === 'admin';
                        const isFirstOfDay = index === 0 || 
                            new Date(allMessages[index - 1].date).toDateString() !== msgDate.toDateString();
                        
                        return `
                            ${isFirstOfDay ? `
                                <div style="text-align: center; margin: 1rem 0;">
                                    <span style="background: rgba(226, 232, 240, 0.5); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; color: var(--text-light);">
                                        ${msgDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                    </span>
                                </div>
                            ` : ''}
                            <div style="display: flex; ${isAdmin ? 'justify-content: flex-end' : 'justify-content: flex-start'}; margin-bottom: 0.5rem;">
                                <div style="max-width: 75%; ${isAdmin ? 'background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;' : 'background: white; color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.1);'} padding: 1rem; border-radius: ${isAdmin ? '1rem 1rem 0.25rem 1rem' : '1rem 1rem 1rem 0.25rem'}; border: 1px solid ${isAdmin ? 'rgba(255,255,255,0.2)' : 'var(--border)'};">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; opacity: ${isAdmin ? '0.9' : '1'};">
                                        ${isAdmin ? '👤 You' : `👤 ${msg.sender}`}
                                    </div>
                                    <div style="white-space: pre-wrap; line-height: 1.6; word-wrap: break-word;">${escapeHtml(msg.message)}</div>
                                    <div style="font-size: 0.7rem; margin-top: 0.5rem; opacity: 0.7;">
                                        ${msgDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Scroll to bottom
                    setTimeout(() => {
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }, 50);
                }
            } catch (error) {
                console.error('Load chat messages error:', error);
                messagesEl.innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem; color: #dc2626;">
                        <p>Failed to load messages: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function handleAdminReply(e) {
            e.preventDefault();
            const messageInput = document.getElementById('adminChatMessage');
            const message = messageInput?.value.trim();
            const charCount = document.getElementById('adminChatCharCount');
            const submitBtn = e.target.querySelector('button[type="submit"]') || e.target.closest('form').querySelector('button[type="submit"]');
            
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            if (message.length > 1000) {
                alert('Message is too long (max 1000 characters)');
                return;
            }
            
            if (!currentChatCaseId) {
                alert('No case selected');
                return;
            }
            
            // Disable form
            if (messageInput) messageInput.disabled = true;
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner" style="width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block;"></span> <span>Sending...</span>';
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/cases/${currentChatCaseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        updates: [{
                            date: new Date().toISOString(),
                            message: message,
                            status: null
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear input
                    if (messageInput) {
                        messageInput.value = '';
                        messageInput.disabled = false;
                    }
                    if (charCount) charCount.textContent = '0 / 1000';
                    
                    // Reload messages
                    const caseResponse = await fetch(`${API_BASE_URL}/api/admin/cases`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    const casesData = await caseResponse.json();
                    const updatedCase = casesData.cases?.find(c => c.id === currentChatCaseId);
                    const clientName = updatedCase?.name || 'Client';
                    
                    await loadAdminChatMessages(currentChatCaseId, clientName);
                    
                    // Reload cases list
                    loadCases();
                } else {
                    throw new Error(data.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Send message error:', error);
                alert('Failed to send message: ' + error.message);
                if (messageInput) messageInput.disabled = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>📤</span> <span>Send Message</span>';
                }
            }
        }


        async function handleEdit(e) {
            e.preventDefault();
            
            const status = document.getElementById('editStatus').value;
            const notes = document.getElementById('editNotes').value.trim();
            
            if (!notes && status === currentCase.status) {
                alert('Please add a note or change the status');
                return;
            }

            const updates = notes ? [{ date: new Date().toISOString(), message: notes, status }] : null;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/cases/${currentCase.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ status, updates })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('✓ Case updated successfully!');
                    window.closeModal();
                    loadCases();
                } else {
                    alert('✗ Failed to update case: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('✗ Failed to update case: ' + error.message);
            }
        }

        async function handleWebmail(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('handleWebmail called');
            
            const to = document.getElementById('webmailTo').value.trim();
            const cc = document.getElementById('webmailCc').value.trim();
            const subject = document.getElementById('webmailSubject').value.trim();
            const message = document.getElementById('webmailMessage').value.trim();
            const caseId = document.getElementById('webmailCaseId').value.trim();
            const priority = document.getElementById('emailPriority').value;
            
            console.log('Form data:', { to, cc, subject, message: message.substring(0, 50), caseId, priority });
            
            // Check if all required fields are filled
            if (!to || !subject || !message) {
                console.log('Validation failed - missing required fields');
                const statusDiv = document.getElementById('webmailStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = 
                        '<div style="color: #dc2626; padding: 0.75rem; background: #fef2f2; border-radius: 0.5rem;">Please fill in all required fields (To, Subject, Message)</div>';
                } else {
                    alert('Please fill in all required fields');
                }
                return;
            }

            const statusDiv = document.getElementById('webmailStatus');
            statusDiv.innerHTML = '<div style="color: #1e40af; padding: 0.75rem; background: #eff6ff; border-radius: 0.5rem;">Sending email...</div>';
            
            const submitBtn = document.querySelector('#webmailForm button[type="submit"]');
            if (submitBtn) {
            submitBtn.disabled = true;
                // Show loading state
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoading = submitBtn.querySelector('.btn-loading');
                if (btnText) btnText.style.display = 'none';
                if (btnLoading) btnLoading.style.display = 'inline-block';
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/send-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ to, cc, subject, message, caseId, priority })
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }

                if (data.success) {
                    statusDiv.innerHTML = '<div style="color: #059669; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem;">✓ Email sent successfully!</div>';
                    
                    // Clear form after successful send
                    document.getElementById('webmailForm').reset();
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        window.closeWebmail();
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `<div style="color: #dc2626; padding: 0.75rem; background: #fef2f2; border-radius: 0.5rem;">✗ Failed: ${escapeHtml(data.error || 'Unknown error')}</div>`;
                    if (submitBtn) {
                    submitBtn.disabled = false;
                        const btnText = submitBtn.querySelector('.btn-text');
                        const btnLoading = submitBtn.querySelector('.btn-loading');
                        if (btnText) btnText.style.display = 'inline-block';
                        if (btnLoading) btnLoading.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Webmail error:', error);
                let errorMsg = error.message;
                if (error.message.includes('JSON')) {
                    errorMsg = 'Server error - please check your email configuration and try again.';
                }
                statusDiv.innerHTML = `<div style="color: #dc2626; padding: 0.75rem; background: #fef2f2; border-radius: 0.5rem;">✗ Failed: ${escapeHtml(errorMsg)}</div>`;
                if (submitBtn) {
                submitBtn.disabled = false;
                    const btnText = submitBtn.querySelector('.btn-text');
                    const btnLoading = submitBtn.querySelector('.btn-loading');
                    if (btnText) btnText.style.display = 'inline-block';
                    if (btnLoading) btnLoading.style.display = 'none';
                }
            }
        }

    </script>
</body>
</html>

